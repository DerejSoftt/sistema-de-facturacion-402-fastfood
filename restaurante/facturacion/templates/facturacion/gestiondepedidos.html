{% load humanize %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gesti贸n de Pedidos - Restaurante</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #ff7e5f 0%, #feb47b 100%);
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        /* App container */
        .app-container {
            display: flex;
            min-height: 100vh;
        }
        
        /* Sidebar styles - FIJADO */
        .sidebar {
            width: 260px;
            height: 100vh;
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.2);
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
            position: fixed;
            left: 0;
            top: 0;
            z-index: 1000;
            overflow-y: auto;
        }
        
        .sidebar-header {
            background: linear-gradient(135deg, #ff7e5f 0%, #feb47b 100%);
            color: white;
            padding: 1.5rem;
            font-size: 1.25rem;
            font-weight: bold;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            position: sticky;
            top: 0;
            z-index: 1001;
        }
        
        .sidebar-nav {
            flex: 1;
            padding: 1rem 0;
            overflow-y: auto;
        }
        
        .nav-item {
            padding: 1rem 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            color: #ecf0f1;
            text-decoration: none;
            transition: all 0.3s;
            cursor: pointer;
            border-left: 3px solid transparent;
        }
        
        .nav-item:hover {
            background: rgba(255, 255, 255, 0.1);
            border-left-color: #ff7e5f;
            color: #ff7e5f;
            transform: translateX(5px);
        }
        
        .nav-item.active {
            background: rgba(255, 255, 255, 0.15);
            border-left-color: #ff7e5f;
            color: #ff7e5f;
            font-weight: 600;
        }
        
        .nav-icon {
            font-size: 1.25rem;
        }
        
        /* Mobile menu toggle */
        .menu-toggle {
            display: none;
            position: fixed;
            top: 1rem;
            left: 1rem;
            z-index: 1002;
            background: #ff7e5f;
            border: none;
            padding: 0.75rem;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            cursor: pointer;
            font-size: 1.5rem;
            color: white;
            transition: all 0.3s;
        }
        
        .menu-toggle:hover {
            background: #ff6b4a;
            transform: scale(1.05);
        }
        
        .sidebar-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 998;
        }
        
        /* Main content area */
        .main-content {
            flex: 1;
            padding: 2rem;
            overflow-x: hidden;
            margin-left: 260px;
            width: calc(100% - 260px);
        }
        
        .container {
            width: 100%;
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 25px;
            box-shadow: 0 25px 70px rgba(0, 0, 0, 0.25);
            overflow: hidden;
            animation: fadeIn 0.5s ease-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Header */
        .header {
            background: linear-gradient(135deg, #ff7e5f 0%, #feb47b 100%);
            color: white;
            padding: 2.5rem;
            text-align: center;
            position: relative;
            overflow: hidden;
        }
        
        .header::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100" preserveAspectRatio="none"><path d="M0,0 L100,0 L100,100 Z" fill="rgba(255,255,255,0.1)"/></svg>');
            background-size: cover;
        }
        
        .header h1 {
            font-size: 2.2rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            position: relative;
            z-index: 1;
        }
        
        .header p {
            opacity: 0.95;
            font-size: 1.1rem;
            position: relative;
            z-index: 1;
        }
        
        .content {
            padding: 2.5rem;
        }
        
        /* Stats Cards */
        .stats-container {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1.5rem;
            margin-bottom: 2.5rem;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #f8f9ff 0%, #ffffff 100%);
            padding: 1.5rem;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(255, 126, 95, 0.1);
            border: 1px solid rgba(255, 126, 95, 0.1);
            text-align: center;
            transition: transform 0.3s;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(255, 126, 95, 0.2);
        }
        
        .stat-icon {
            font-size: 2rem;
            margin-bottom: 1rem;
            display: block;
        }
        
        .stat-value {
            font-size: 1.8rem;
            font-weight: bold;
            color: #ff7e5f;
            margin-bottom: 0.5rem;
        }
        
        .stat-label {
            color: #4a5568;
            font-size: 0.95rem;
            font-weight: 600;
        }
        
        /* Controls Section */
        .controls-section {
            background: linear-gradient(135deg, #f8f9ff 0%, #ffffff 100%);
            padding: 2rem;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(255, 126, 95, 0.1);
            border: 1px solid rgba(255, 126, 95, 0.1);
            margin-bottom: 2rem;
        }
        
        .controls-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
            gap: 1rem;
        }
        
        .controls-header h3 {
            color: #2c3e50;
            font-size: 1.4rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .controls-header h3::before {
            content: "";
            font-size: 1.2rem;
        }
        
        /* Botones */
        .btn {
            padding: 1rem 2.5rem;
            border: none;
            border-radius: 12px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #ff7e5f 0%, #feb47b 100%);
            color: white;
            box-shadow: 0 10px 20px rgba(255, 126, 95, 0.3);
        }
        
        .btn-primary:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 25px rgba(255, 126, 95, 0.4);
        }
        
        .btn-warning {
            background: linear-gradient(135deg, #ffb347 0%, #ffcc33 100%);
            color: #2c3e50;
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
            box-shadow: 0 4px 6px rgba(255, 179, 71, 0.3);
        }
        
        .btn-warning:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 10px rgba(255, 179, 71, 0.4);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #ff416c 0%, #ff4b2b 100%);
            color: white;
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
            box-shadow: 0 4px 6px rgba(255, 65, 108, 0.3);
        }
        
        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 10px rgba(255, 65, 108, 0.4);
        }
        
        .btn-sm {
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
        }
        
        /* Form inputs */
        .form-group {
            display: flex;
            flex-direction: column;
            margin-bottom: 1rem;
        }
        
        .form-group label {
            font-weight: 600;
            margin-bottom: 0.75rem;
            color: #2c3e50;
            font-size: 0.95rem;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .form-group input,
        .form-group select {
            padding: 1rem;
            border: 2px solid #e0e6ff;
            border-radius: 12px;
            font-size: 1rem;
            transition: all 0.3s;
            background: white;
            box-shadow: 0 4px 6px rgba(50, 50, 93, 0.05);
        }
        
        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #ff7e5f;
            box-shadow: 0 0 0 3px rgba(255, 126, 95, 0.2);
            transform: translateY(-2px);
        }
        
        .search-box {
            flex: 1;
            min-width: 300px;
            position: relative;
        }
        
        .search-box input {
            width: 100%;
            padding: 1rem 1rem 1rem 3.5rem;
        }
        
        .search-icon {
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            font-size: 1.2rem;
            color: #ff7e5f;
        }
        
        .filter-select {
            padding: 1rem;
            border: 2px solid #e0e6ff;
            border-radius: 12px;
            font-size: 1rem;
            background: white;
            min-width: 180px;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 6px rgba(50, 50, 93, 0.05);
        }
        
        .filter-select:focus {
            outline: none;
            border-color: #ff7e5f;
            box-shadow: 0 0 0 3px rgba(255, 126, 95, 0.2);
        }
        
        .filter-row {
            display: flex;
            gap: 1rem;
            align-items: flex-end;
            flex-wrap: wrap;
        }
        
        /* Platos Table */
        .table-container {
            background: white;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(255, 126, 95, 0.1);
            border: 1px solid rgba(255, 126, 95, 0.1);
            margin-bottom: 2rem;
            overflow-x: auto;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 800px;
        }
        
        thead {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
        }
        
        thead th {
            padding: 1.5rem;
            text-align: left;
            font-weight: 600;
            font-size: 0.95rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        tbody tr {
            border-bottom: 1px solid rgba(255, 126, 95, 0.1);
            transition: all 0.2s;
        }
        
        tbody tr:hover {
            background: #f8f9ff;
            transform: translateY(-1px);
            box-shadow: 0 5px 15px rgba(255, 126, 95, 0.1);
        }
        
        tbody td {
            padding: 1.5rem;
            color: #4a5568;
        }
        
        /* Category badges */
        .category-badge {
            display: inline-block;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .category-entrada { 
            background: linear-gradient(135deg, #ffb347 0%, #ffcc33 100%); 
            color: #7c2d12; 
        }
        .category-principal { 
            background: linear-gradient(135deg, #f687b3 0%, #ed64a6 100%); 
            color: #702459; 
        }
        .category-postre { 
            background: linear-gradient(135deg, #fbd38d 0%, #f6ad55 100%); 
            color: #7c2d12; 
        }
        .category-bebida { 
            background: linear-gradient(135deg, #bee3f8 0%, #90cdf4 100%); 
            color: #2c5282; 
        }
        .category-rapida { 
            background: linear-gradient(135deg, #c6f6d5 0%, #9ae6b4 100%); 
            color: #22543d; 
        }
        .category-especial { 
            background: linear-gradient(135deg, #e9d8fd 0%, #d6bcfa 100%); 
            color: #44337a; 
        }
        
        /* Action buttons */
        .action-buttons {
            display: flex;
            gap: 0.5rem;
        }
        
        .btn-icon {
            padding: 0.5rem;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 1rem;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #f8f9ff 0%, #e9ecff 100%);
            color: #667eea;
        }
        
        .btn-icon:hover {
            transform: scale(1.1);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.2);
        }
        
        .btn-edit:hover {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-delete:hover {
            background: linear-gradient(135deg, #ff416c 0%, #ff4b2b 100%);
            color: white;
        }
        
        /* Pagination */
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 0.5rem;
            margin-top: 2rem;
        }
        
        .page-btn {
            padding: 0.75rem 1.25rem;
            border: 2px solid #e0e6ff;
            background: white;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 600;
            color: #4a5568;
        }
        
        .page-btn:hover {
            background: #f8f9ff;
            border-color: #ff7e5f;
            color: #ff7e5f;
        }
        
        .page-btn.active {
            background: linear-gradient(135deg, #ff7e5f 0%, #feb47b 100%);
            color: white;
            border-color: #ff7e5f;
        }
        
        .page-info {
            padding: 0 1rem;
            color: #4a5568;
            font-weight: 600;
        }
        
        /* Empty state */
        .empty-state {
            text-align: center;
            padding: 4rem;
            color: #a0aec0;
        }
        
        .empty-state svg {
            width: 80px;
            height: 80px;
            margin: 0 auto 1rem;
            opacity: 0.5;
        }
        
        .empty-state h3 {
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
            color: #4a5568;
        }
        
        /* Responsive design */
        @media (max-width: 1200px) {
            .stats-container {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        @media (max-width: 768px) {
            .menu-toggle {
                display: block;
            }
            
            .sidebar {
                position: fixed;
                top: 0;
                left: 0;
                bottom: 0;
                z-index: 999;
                transform: translateX(-100%);
            }
            
            .sidebar.open {
                transform: translateX(0);
            }
            
            .sidebar-overlay.open {
                display: block;
            }
            
            .main-content {
                padding: 5rem 1rem 1rem;
                margin-left: 0;
                width: 100%;
            }
            
            .content {
                padding: 1.5rem;
            }
            
            .header {
                padding: 2rem 1.5rem;
            }
            
            .header h1 {
                font-size: 1.8rem;
            }
            
            .stats-container {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
            
            .controls-header {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .filter-row {
                flex-direction: column;
                width: 100%;
            }
            
            .search-box {
                min-width: 100%;
            }
            
            .filter-select {
                width: 100%;
            }
            
            .action-buttons {
                flex-direction: column;
            }
            
            .table-container {
                border-radius: 15px;
            }
            
            table {
                min-width: 1000px;
            }
        }
        
        @media (max-width: 480px) {
            .stats-container {
                grid-template-columns: 1fr;
            }
            
            .btn {
                width: 100%;
                justify-content: center;
            }
        }
        
        /* Estilos para Modales */
        .modal, .status-modal, .edit-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 9999;
            align-items: center;
            justify-content: center;
            overflow-y: auto;
        }
        
        .modal.active, .status-modal.active, .edit-modal.active {
            display: flex;
        }
        
        .modal-content, .status-modal-content, .edit-modal-content {
            background: white;
            border-radius: 20px;
            max-width: 900px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 25px 70px rgba(0, 0, 0, 0.3);
            animation: modalSlideIn 0.3s ease-out;
        }
        
        @keyframes modalSlideIn {
            from { 
                opacity: 0; 
                transform: translateY(-50px); 
            }
            to { 
                opacity: 1; 
                transform: translateY(0); 
            }
        }
        
        .modal-header, .status-modal-header, .edit-modal-header {
            background: linear-gradient(135deg, #ff7e5f 0%, #feb47b 100%);
            color: white;
            padding: 1.5rem 2rem;
            border-radius: 20px 20px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-header h3, .status-modal-header h3, .edit-modal-header h3 {
            font-size: 1.5rem;
            font-weight: 700;
        }
        
        .modal-close {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            font-size: 2rem;
            cursor: pointer;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            line-height: 1;
        }
        
        .modal-close:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: rotate(90deg);
        }
        
        .modal-body, .status-modal-body, .edit-modal-body {
            padding: 2rem;
        }
        
        /* Estilos para items del pedido en modales */
        .order-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            background: #f8f9ff;
            border-radius: 12px;
            margin-bottom: 0.75rem;
            border: 1px solid #e0e6ff;
        }
        
        .order-item-edit {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            background: #f8f9ff;
            border-radius: 12px;
            margin-bottom: 0.75rem;
            border: 2px solid #e0e6ff;
            transition: all 0.3s;
        }
        
        .order-item-edit:hover {
            border-color: #ff7e5f;
            box-shadow: 0 5px 15px rgba(255, 126, 95, 0.1);
        }
        
        /* Estilos para opciones de estado */
        .status-option {
            padding: 1.5rem;
            border: 2px solid #e0e6ff;
            border-radius: 12px;
            margin-bottom: 1rem;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .status-option:hover {
            border-color: #ff7e5f;
            background: #f8f9ff;
            transform: translateX(5px);
        }
        
        .status-option.selected {
            border-color: #ff7e5f;
            background: linear-gradient(135deg, #fff5f0 0%, #fff8f5 100%);
            box-shadow: 0 5px 15px rgba(255, 126, 95, 0.2);
        }
        
        .status-option-icon {
            font-size: 2rem;
            width: 60px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .status-option-label {
            flex: 1;
        }
        
        .status-option-label div:first-child {
            font-size: 1.2rem;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 0.25rem;
        }
        
        .status-option-label div:last-child {
            font-size: 0.9rem;
            color: #718096;
        }
        
        /* Estilos para controles de cantidad */
        .cantidad-controls {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background: white;
            border-radius: 10px;
            padding: 0.25rem;
            border: 2px solid #e0e6ff;
        }
        
        .cantidad-btn {
            width: 30px;
            height: 30px;
            border: none;
            background: linear-gradient(135deg, #ff7e5f 0%, #feb47b 100%);
            color: white;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 700;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        
        .cantidad-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 10px rgba(255, 126, 95, 0.3);
        }
        
        .cantidad-input {
            width: 50px;
            text-align: center;
            border: none;
            font-weight: 700;
            font-size: 1rem;
            color: #2c3e50;
        }
        
        /* Estilos para formularios de edici贸n */
        .edit-form-group {
            margin-bottom: 1.5rem;
        }
        
        .edit-form-group label {
            display: block;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 0.5rem;
            font-size: 0.95rem;
        }
        
        .edit-form-group input,
        .edit-form-group textarea,
        .edit-form-group select {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e0e6ff;
            border-radius: 10px;
            font-size: 1rem;
            transition: all 0.3s;
        }
        
        .edit-form-group input:focus,
        .edit-form-group textarea:focus,
        .edit-form-group select:focus {
            outline: none;
            border-color: #ff7e5f;
            box-shadow: 0 0 0 3px rgba(255, 126, 95, 0.1);
        }
        
        /* Estilos para lista de productos disponibles */
        #productosDisponiblesList {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 1rem;
            max-height: 300px;
            overflow-y: auto;
            margin-top: 1rem;
        }
        
        .producto-item {
            padding: 1rem;
            background: #f8f9ff;
            border: 2px solid #e0e6ff;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }
        
        .producto-item:hover {
            border-color: #ff7e5f;
            background: white;
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(255, 126, 95, 0.2);
        }
        
        .producto-item strong {
            display: block;
            color: #2c3e50;
            margin-bottom: 0.5rem;
            font-size: 1rem;
        }
        
        .producto-item span {
            color: #ff7e5f;
            font-weight: 700;
            font-size: 1.1rem;
        }
        
        /* Estilos para b煤squeda de productos */
        .search-bebidas {
            position: relative;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background: white;
            border: 2px solid #e0e6ff;
            border-radius: 12px;
            padding: 0.5rem;
            transition: all 0.3s;
        }
        
        .search-bebidas:focus-within {
            border-color: #ff7e5f;
            box-shadow: 0 0 0 3px rgba(255, 126, 95, 0.1);
        }
        
        .search-bebidas-icon {
            padding: 0 0.5rem;
            color: #ff7e5f;
            font-size: 1.2rem;
        }
        
        .search-bebidas input {
            flex: 1;
            border: none;
            outline: none;
            padding: 0.5rem;
            font-size: 1rem;
            background: transparent;
        }
        
        .search-bebidas-btn {
            padding: 0.75rem 1.5rem;
            background: linear-gradient(135deg, #ff7e5f 0%, #feb47b 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            box-shadow: 0 4px 10px rgba(255, 126, 95, 0.2);
        }
        
        .search-bebidas-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(255, 126, 95, 0.3);
        }
        
        .search-bebidas-btn:active {
            transform: translateY(0);
        }
        
        /* Ajuste para bot贸n eliminar en edici贸n */
        .order-item-edit .btn-danger {
            margin-left: 1rem;
        }
        
        /* Estilos para estado actual en modal de edici贸n */
        .edit-modal .status-badge {
            display: inline-block;
            padding: 0.75rem 1.5rem;
            border-radius: 12px;
            font-weight: 700;
            font-size: 1.1rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        
        .edit-modal .status-badge.pendiente {
            background: linear-gradient(135deg, #ffd89b 0%, #19547b 100%);
            color: white;
        }
        
        .edit-modal .status-badge.preparando {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .edit-modal .status-badge.listo {
            background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
            color: white;
        }
        
        .edit-modal .status-badge.completado {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
        }
        
        .edit-modal .status-badge.cancelado {
            background: linear-gradient(135deg, #f857a6 0%, #ff5858 100%);
            color: white;
        }
    </style>
</head>
<body>
    <!-- Mobile menu toggle -->
    <button class="menu-toggle" onclick="toggleSidebar()"><i class="fas fa-bars"></i></button>
    
    <div class="app-container">
        <!-- Sidebar navigation -->
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <i class="fas fa-utensils"></i> Mi Restaurante
            </div>
            <nav class="sidebar-nav">
                {% with user_groups=user.groups.all|join:"," %}
                
                <!-- Men煤 para Usuario Normal -->
                {% if "Usuario Normal" in user_groups and not user.is_superuser %}
                <a href="{% url 'pedidos' %}" class="nav-item {% if request.resolver_match.url_name == 'pedidos' %}active{% endif %}">
                    <span class="nav-icon"><i class="fas fa-shopping-cart"></i></span>
                    <span>Pedidos</span>
                </a>
                <a href="{% url 'inventario' %}" class="nav-item {% if request.resolver_match.url_name == 'inventario' %}active{% endif %}">
                    <span class="nav-icon"><i class="fas fa-clipboard-list"></i></span>
                    <span>Inventario</span>
                </a>
                <a href="{% url 'gestiondepedidos' %}" class="nav-item {% if request.resolver_match.url_name == 'gestiondepedidos' %}active{% endif %}">
                    <span class="nav-icon"><i class="fas fa-tasks"></i></span>
                    <span>Gesti贸n de Pedidos</span>
                </a>
                <a href="{% url 'facturacion' %}" class="nav-item {% if request.resolver_match.url_name == 'facturacion' %}active{% endif %}">
                    <span class="nav-icon"><i class="fas fa-receipt"></i></span>
                    <span>Facturaci贸n</span>
                </a>
                <a href="{% url 'salida' %}" class="nav-item {% if request.resolver_match.url_name == 'salida' %}active{% endif %}">
                    <span class="nav-icon"><i class="fas fa-box-open"></i></span>
                    <span>Salida de Productos</span>
                </a>
                {% endif %}
                
                <!-- Men煤 para Administrador -->
                {% if "Administrador" in user_groups and not user.is_superuser %}
                <a href="{% url 'entradadeproductos' %}" class="nav-item {% if request.resolver_match.url_name == 'entradadeproductos' %}active{% endif %}">
                    <span class="nav-icon"><i class="fas fa-box"></i></span>
                    <span>Entrada de Productos</span>
                </a>
                <a href="{% url 'inventario' %}" class="nav-item {% if request.resolver_match.url_name == 'inventario' %}active{% endif %}">
                    <span class="nav-icon"><i class="fas fa-clipboard-list"></i></span>
                    <span>Inventario</span>
                </a>
                <a href="{% url 'entradadeplatillos' %}" class="nav-item {% if request.resolver_match.url_name == 'entradadeplatillos' %}active{% endif %}">
                    <span class="nav-icon"><i class="fas fa-utensils"></i></span>
                    <span>Entrada de Platos</span>
                </a>
                <a href="{% url 'listadeplatillos' %}" class="nav-item {% if request.resolver_match.url_name == 'listadeplatillos' %}active{% endif %}">
                    <span class="nav-icon"><i class="fas fa-chart-bar"></i></span>
                    <span>Gesti贸n de Platos</span>
                </a>
                <a href="{% url 'pedidos' %}" class="nav-item {% if request.resolver_match.url_name == 'pedidos' %}active{% endif %}">
                    <span class="nav-icon"><i class="fas fa-shopping-cart"></i></span>
                    <span>Pedidos</span>
                </a>
                <a href="{% url 'gestiondepedidos' %}" class="nav-item {% if request.resolver_match.url_name == 'gestiondepedidos' %}active{% endif %}">
                    <span class="nav-icon"><i class="fas fa-tasks"></i></span>
                    <span>Gesti贸n de Pedidos</span>
                </a>
                <a href="{% url 'facturacion' %}" class="nav-item {% if request.resolver_match.url_name == 'facturacion' %}active{% endif %}">
                    <span class="nav-icon"><i class="fas fa-receipt"></i></span>
                    <span>Facturaci贸n</span>
                </a>
                <a href="{% url 'salida' %}" class="nav-item {% if request.resolver_match.url_name == 'salida' %}active{% endif %}">
                    <span class="nav-icon"><i class="fas fa-box-open"></i></span>
                    <span>Salida de Productos</span>
                </a>
                <a href="{% url 'roles' %}" class="nav-item {% if request.resolver_match.url_name == 'roles' %}active{% endif %}">
                    <span class="nav-icon"><i class="fas fa-users"></i></span>
                    <span>Gesti贸n de Usuarios</span>
                </a>
                <a href="{% url 'dashbort' %}" class="nav-item {% if request.resolver_match.url_name == 'dashbort' %}active{% endif %}">
                    <span class="nav-icon"><i class="fas fa-chart-bar"></i></span>
                    <span>Dashboard</span>
                </a>
                {% endif %}
                
                <!-- Men煤 para Gerente -->
                {% if "Gerente" in user_groups and not user.is_superuser %}
                <a href="{% url 'entradadeproductos' %}" class="nav-item {% if request.resolver_match.url_name == 'entradadeproductos' %}active{% endif %}">
                    <span class="nav-icon"><i class="fas fa-box"></i></span>
                    <span>Entrada de Productos</span>
                </a>
                <a href="{% url 'inventario' %}" class="nav-item {% if request.resolver_match.url_name == 'inventario' %}active{% endif %}">
                    <span class="nav-icon"><i class="fas fa-list"></i></span>
                    <span>Inventario</span>
                </a>
                <a href="{% url 'entradadeplatillos' %}" class="nav-item {% if request.resolver_match.url_name == 'entradadeplatillos' %}active{% endif %}">
                    <span class="nav-icon"><i class="fas fa-utensils"></i></span>
                    <span>Entrada de Platos</span>
                </a>
                <a href="{% url 'listadeplatillos' %}" class="nav-item {% if request.resolver_match.url_name == 'listadeplatillos' %}active{% endif %}">
                    <span class="nav-icon"><i class="fas fa-chart-bar"></i></span>
                    <span>Gesti贸n de Platos</span>
                </a>
                <a href="{% url 'pedidos' %}" class="nav-item {% if request.resolver_match.url_name == 'pedidos' %}active{% endif %}">
                    <span class="nav-icon"><i class="fas fa-shopping-cart"></i></span>
                    <span>Pedidos</span>
                </a>
                <a href="{% url 'gestiondepedidos' %}" class="nav-item {% if request.resolver_match.url_name == 'gestiondepedidos' %}active{% endif %}">
                    <span class="nav-icon"><i class="fas fa-list"></i></span>
                    <span>Gesti贸n de Pedidos</span>
                </a>
                <a href="{% url 'facturacion' %}" class="nav-item {% if request.resolver_match.url_name == 'facturacion' %}active{% endif %}">
                    <span class="nav-icon"><i class="fas fa-receipt"></i></span>
                    <span>Facturaci贸n</span>
                </a>
                <a href="{% url 'salida' %}" class="nav-item {% if request.resolver_match.url_name == 'salida' %}active{% endif %}">
                    <span class="nav-icon"><i class="fas fa-sign-out-alt"></i></span>
                    <span>Salida de Productos</span>
                </a>
                <a href="{% url 'dashbort' %}" class="nav-item {% if request.resolver_match.url_name == 'dashbort' %}active{% endif %}">
                    <span class="nav-icon"><i class="fas fa-chart-bar"></i></span>
                    <span>Dashboard</span>
                </a>
                {% endif %}
                
                {% if "Cajero" in user_groups and not user.is_superuser %}
                <a href="{% url 'pedidos' %}" class="nav-item {% if request.resolver_match.url_name == 'pedidos' %}active{% endif %}">
                    <span class="nav-icon"><i class="fas fa-shopping-cart"></i></span>
                    <span>Pedidos</span>
                </a>
                <a href="{% url 'facturacion' %}" class="nav-item {% if request.resolver_match.url_name == 'facturacion' %}active{% endif %}">
                    <span class="nav-icon"><i class="fas fa-receipt"></i></span>
                    <span>Facturaci贸n</span>
                </a>
                {% endif %}
                
                <!-- Men煤 EXCLUSIVO para superusuarios -->
                {% if user.is_superuser %}
                <a href="{% url 'entradadeproductos' %}" class="nav-item {% if request.resolver_match.url_name == 'entradadeproductos' %}active{% endif %}">
                    <span class="nav-icon"><i class="fas fa-box"></i></span>
                    <span>Entrada de Productos</span>
                </a>
                <a href="{% url 'inventario' %}" class="nav-item {% if request.resolver_match.url_name == 'inventario' %}active{% endif %}">
                    <span class="nav-icon"><i class="fas fa-clipboard-list"></i></span>
                    <span>Inventario</span>
                </a>
                <a href="{% url 'entradadeplatillos' %}" class="nav-item {% if request.resolver_match.url_name == 'entradadeplatillos' %}active{% endif %}">
                    <span class="nav-icon"><i class="fas fa-utensils"></i></span>
                    <span>Entrada de Platos</span>
                </a>
                <a href="{% url 'listadeplatillos' %}" class="nav-item {% if request.resolver_match.url_name == 'listadeplatillos' %}active{% endif %}">
                    <span class="nav-icon"><i class="fas fa-chart-bar"></i></span>
                    <span>Gesti贸n de Platos</span>
                </a>
                <a href="{% url 'pedidos' %}" class="nav-item {% if request.resolver_match.url_name == 'pedidos' %}active{% endif %}">
                    <span class="nav-icon"><i class="fas fa-shopping-cart"></i></span>
                    <span>Pedidos</span>
                </a>
                <a href="{% url 'gestiondepedidos' %}" class="nav-item {% if request.resolver_match.url_name == 'gestiondepedidos' %}active{% endif %}">
                    <span class="nav-icon"><i class="fas fa-tasks"></i></span>
                    <span>Gesti贸n de Pedidos</span>
                </a>
                <a href="{% url 'facturacion' %}" class="nav-item {% if request.resolver_match.url_name == 'facturacion' %}active{% endif %}">
                    <span class="nav-icon"><i class="fas fa-receipt"></i></span>
                    <span>Facturaci贸n</span>
                </a>
                <a href="{% url 'salida' %}" class="nav-item {% if request.resolver_match.url_name == 'salida' %}active{% endif %}">
                    <span class="nav-icon"><i class="fas fa-box-open"></i></span>
                    <span>Salida de Productos</span>
                </a>
                <a href="{% url 'roles' %}" class="nav-item {% if request.resolver_match.url_name == 'roles' %}active{% endif %}">
                    <span class="nav-icon"><i class="fas fa-users"></i></span>
                    <span>Gesti贸n de Usuarios</span>
                </a>
                <a href="{% url 'dashbort' %}" class="nav-item {% if request.resolver_match.url_name == 'dashbort' %}active{% endif %}">
                    <span class="nav-icon"><i class="fas fa-chart-bar"></i></span>
                    <span>Dashboard</span>
                </a>
                {% endif %}
                
                <!-- Cerrar sesi贸n para todos -->
                <a href="{% url 'logout' %}" class="nav-item">
                    <span class="nav-icon"><i class="fas fa-sign-out-alt"></i></span>
                    <span>Cerrar Sesi贸n</span>
                </a>
                
                {% endwith %}
            </nav>
        </div>
        
        <!-- Overlay for mobile sidebar -->
        <div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar()"></div>
        
        <div class="main-content">
            <div class="container">
                <div class="header">
                    <h1><i class="fas fa-clipboard-list"></i> Gesti贸n de Pedidos Activos</h1>
                    <p>Administra y controla todos los pedidos del restaurante que a煤n no est谩n pagados</p>
                    <div style="margin-top: 1rem; background: rgba(255, 255, 255, 0.2); padding: 0.5rem 1rem; border-radius: 10px; font-size: 0.9rem;">
                        <strong><i class="fas fa-lightbulb"></i> Nota:</strong> Solo se muestran pedidos que no tienen facturas pagadas. 
                        Los pedidos pagados est谩n en el <a href="{% url 'historial_pedidos' %}" style="color: white; text-decoration: underline;">historial</a>.
                    </div>
                </div>
                
                <div class="content">
                    <!-- Stats Cards -->
                    <div class="stats-container">
                        <div class="stat-card">
                            <span class="stat-icon"><i class="fas fa-clipboard-list"></i></span>
                            <div class="stat-value" id="totalPedidos">{{ estadisticas.total_pedidos }}</div>
                            <div class="stat-label">Pedidos Activos</div>
                        </div>
                        <div class="stat-card">
                            <span class="stat-icon"><i class="fas fa-clock"></i></span>
                            <div class="stat-value" id="pedidosPendientes">{{ estadisticas.pedidos_pendientes }}</div>
                            <div class="stat-label">Pendientes</div>
                        </div>
                        <div class="stat-card">
                            <span class="stat-icon"><i class="fas fa-dollar-sign"></i></span>
                            <div class="stat-value" id="ingresosHoy">$<span id="ingresosHoyValor">{{ estadisticas.ingresos_hoy }}</span></div>
                            <div class="stat-label">Ingresos Hoy</div>
                        </div>
                        <div class="stat-card">
                            <span class="stat-icon"><i class="fas fa-truck"></i></span>
                            <div class="stat-value" id="pedidosDomicilio">{{ estadisticas.pedidos_domicilio }}</div>
                            <div class="stat-label">A Domicilio</div>
                        </div>
                    </div>
                    
                    <!-- Controls Section -->
                    <div class="controls-section">
                        <div class="controls-header">
                            <h3>Buscar y Filtrar Pedidos Activos</h3>
                            <div style="display: flex; gap: 1rem;">
                                <button class="btn btn-success btn-sm" onclick="window.location.href='{% url 'historial_pedidos' %}'" type="button">
                                    <span><i class="fas fa-history"></i></span>
                                    <span>Ver Historial Pagados</span>
                                </button>
                                <button class="btn btn-primary btn-sm" onclick="exportOrders()" type="button">
                                    <span><i class="fas fa-file-export"></i></span>
                                    <span>Exportar Pedidos</span>
                                </button>
                            </div>
                        </div>
                        
                        <form method="get" id="filterForm">
                            <div class="form-group">
                                <label for="searchInput"><i class="fas fa-search"></i> Buscar Pedido</label>
                                <div class="search-box">
                                    <span class="search-icon"><i class="fas fa-search"></i></span>
                                    <input type="text" id="searchInput" name="search" 
                                           value="{{ filtros.search }}"
                                           placeholder="Buscar por cliente, n煤mero de pedido o tel茅fono...">
                                </div>
                            </div>
                            
                            <div class="filter-row">
                                <div class="form-group" style="flex: 1;">
                                    <label for="statusFilter"><i class="fas fa-chart-pie"></i> Estado</label>
                                    <select class="filter-select" id="statusFilter" name="estado">
                                        <option value="">Todos los estados</option>
                                        <option value="pendiente" {% if filtros.estado == 'pendiente' %}selected{% endif %}>Pendiente</option>
                                        <option value="confirmado" {% if filtros.estado == 'confirmado' %}selected{% endif %}>Confirmado</option>
                                        <option value="preparacion" {% if filtros.estado == 'preparacion' %}selected{% endif %}>En Preparaci贸n</option>
                                        <option value="listo" {% if filtros.estado == 'listo' %}selected{% endif %}>Listo</option>
                                        <option value="entregado" {% if filtros.estado == 'entregado' %}selected{% endif %}>Entregado</option>
                                        <option value="completado" {% if filtros.estado == 'completado' %}selected{% endif %}>Completado</option>
                                        <option value="cancelado" {% if filtros.estado == 'cancelado' %}selected{% endif %}>Cancelado</option>
                                    </select>
                                </div>
                                
                                <div class="form-group" style="flex: 1;">
                                    <label for="typeFilter"><i class="fas fa-truck"></i> Tipo de Pedido</label>
                                    <select class="filter-select" id="typeFilter" name="tipo">
                                        <option value="">Todos los tipos</option>
                                        <option value="mesa" {% if filtros.tipo_pedido == 'mesa' %}selected{% endif %}>Comer en Restaurante</option>
                                        <option value="delivery" {% if filtros.tipo_pedido == 'delivery' %}selected{% endif %}>Domicilio</option>
                                        <option value="llevar" {% if filtros.tipo_pedido == 'llevar' %}selected{% endif %}>Recoger en Local</option>
                                    </select>
                                </div>
                                
                                <div class="form-group" style="flex: 1;">
                                    <label for="dateFilter"><i class="fas fa-calendar"></i> Fecha</label>
                                    <select class="filter-select" id="dateFilter" name="fecha">
                                        <option value="">Todas las fechas</option>
                                        <option value="hoy" {% if filtros.fecha == 'hoy' %}selected{% endif %}>Hoy</option>
                                        <option value="ayer" {% if filtros.fecha == 'ayer' %}selected{% endif %}>Ayer</option>
                                        <option value="semana" {% if filtros.fecha == 'semana' %}selected{% endif %}>Esta Semana</option>
                                        <option value="mes" {% if filtros.fecha == 'mes' %}selected{% endif %}>Este Mes</option>
                                    </select>
                                </div>
                                
                                <div class="form-group" style="flex: 1;">
                                    <label for="sortFilter"><i class="fas fa-sort"></i> Ordenar por</label>
                                    <select class="filter-select" id="sortFilter" name="sort">
                                        <option value="fecha_desc" {% if filtros.sort == 'fecha_desc' %}selected{% endif %}>M谩s Reciente</option>
                                        <option value="fecha_asc" {% if filtros.sort == 'fecha_asc' %}selected{% endif %}>M谩s Antiguo</option>
                                        <option value="total_desc" {% if filtros.sort == 'total_desc' %}selected{% endif %}>Total (Mayor)</option>
                                        <option value="total_asc" {% if filtros.sort == 'total_asc' %}selected{% endif %}>Total (Menor)</option>
                                        <option value="cliente" {% if filtros.sort == 'cliente' %}selected{% endif %}>Cliente (A-Z)</option>
                                    </select>
                                </div>
                                
                                <button type="submit" class="btn btn-primary" style="height: fit-content; margin-top: 1.5rem;">
                                    <span><i class="fas fa-filter"></i></span>
                                    <span>Filtrar</span>
                                </button>
                            </div>
                        </form>
                    </div>
                    
                    <!-- Pedidos Table -->
                    <div class="table-container">
                        <table id="pedidosTable">
                            <thead>
                                <tr>
                                    <th>Pedido #</th>
                                    <th>Cliente</th>
                                    <th>Fecha</th>
                                    <th>Items</th>
                                    <th>Tipo</th>
                                    <th>Total</th>
                                    <th>Estado</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="pedidosBody">
                                {% if pedidos %}
                                    {% for pedido in pedidos %}
                                    <tr data-order-id="{{ pedido.id }}">
                                        <td style="font-weight: 700; color: #2c3e50;">{{ pedido.codigo_pedido }}</td>
                                        <td>
                                            <div class="customer-info">
                                                <div class="customer-name">
                                                    {{ pedido.customer_name }}
                                                    {% if pedido.mesa_numero %}
                                                        <div style="font-size: 0.85rem; color: #718096;">Mesa {{ pedido.mesa_numero }}</div>
                                                    {% endif %}
                                                </div>
                                                {% if pedido.customer_phone %}
                                                    <div class="customer-phone"><i class="fas fa-phone"></i> {{ pedido.customer_phone }}</div>
                                                {% endif %}
                                                {% if pedido.customer_address %}
                                                    <div class="customer-phone"><i class="fas fa-map-marker-alt"></i> {{ pedido.customer_address|truncatechars:30 }}</div>
                                                {% endif %}
                                            </div>
                                        </td>
                                        <td>
                                            <div class="date-badge">
                                                <span><i class="fas fa-calendar-alt"></i></span>
                                                <span>{{ pedido.fecha_formateada }}</span>
                                            </div>
                                        </td>
                                        <td>
                                            <div class="order-items">
                                                {% for item in pedido.items|slice:":2" %}
                                                    <div class="order-item">
                                                        <div>
                                                            <div class="item-name">{{ item.name }}</div>
                                                            <div class="item-details">
                                                                <span>{{ item.quantity }}x</span>
                                                                <span>${{ item.price|floatformat:2|intcomma }} c/u</span>
                                                            </div>
                                                        </div>
                                                        <div class="item-total">${{ item.total|floatformat:2|intcomma }}</div>
                                                    </div>
                                                {% endfor %}
                                                {% if pedido.cantidad_items > 2 %}
                                                    <div style="text-align: center; color: #718096; font-size: 0.9rem;">
                                                        + {{ pedido.cantidad_items|add:"-2" }} m谩s
                                                    </div>
                                                {% endif %}
                                            </div>
                                        </td>
                                        <td>
                                            {% if pedido.tipo_pedido == 'restaurante' %}
                                                <span class="order-type-badge type-restaurante">
                                                    <span><i class="fas fa-utensils"></i></span>
                                                    Restaurante
                                                </span>
                                            {% elif pedido.tipo_pedido == 'domicilio' %}
                                                <span class="order-type-badge type-domicilio">
                                                    <span><i class="fas fa-truck"></i></span>
                                                    Domicilio
                                                </span>
                                            {% else %}
                                                <span class="order-type-badge type-recoger">
                                                    <span><i class="fas fa-walking"></i></span>
                                                    Recoger
                                                </span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <div class="order-total">${{ pedido.total|floatformat:2|intcomma }}</div>
                                        </td>
                                        <td>
                                            {% if pedido.estado == 'pendiente' or pedido.estado == 'confirmado' %}
                                                <span class="status-badge status-pendiente">
                                                    <span class="status-icon"><i class="fas fa-clock"></i></span>
                                                    {{ pedido.estado_display }}
                                                </span>
                                            {% elif pedido.estado == 'preparacion' %}
                                                <span class="status-badge status-preparacion">
                                                    <span class="status-icon"><i class="fas fa-concierge-bell"></i></span>
                                                    {{ pedido.estado_display }}
                                                </span>
                                            {% elif pedido.estado == 'listo' %}
                                                <span class="status-badge status-listo">
                                                    <span class="status-icon"><i class="fas fa-check-circle"></i></span>
                                                    {{ pedido.estado_display }}
                                                </span>
                                            {% elif pedido.estado == 'entregado' or pedido.estado == 'completado' %}
                                                <span class="status-badge status-entregado">
                                                    <span class="status-icon"><i class="fas fa-box"></i></span>
                                                    {{ pedido.estado_display }}
                                                </span>
                                            {% else %}
                                                <span class="status-badge status-cancelado">
                                                    <span class="status-icon"><i class="fas fa-times-circle"></i></span>
                                                    {{ pedido.estado_display }}
                                                </span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <div class="action-buttons">
                                                <button class="btn-icon btn-view" onclick="viewOrderDetails({{ pedido.id }})" title="Ver detalles">
                                                    <i class="fas fa-eye"></i>
                                                </button>
                                                <button class="btn-icon btn-edit" onclick="openEditModal({{ pedido.id }})" title="Editar pedido">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                                <button class="btn-icon btn-danger" onclick="deleteOrder({{ pedido.id }})" title="Eliminar pedido de la vista">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                {% else %}
                                    <tr class="empty-state">
                                        <td colspan="8">
                                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
                                            </svg>
                                            <h3>No se encontraron pedidos activos</h3>
                                            <p>Todos los pedidos est谩n pagados o no hay pedidos con los filtros aplicados</p>
                                            <div style="margin-top: 1rem;">
                                                <a href="{% url 'historial_pedidos' %}" class="btn btn-success" style="text-decoration: none;">
                                                    <span><i class="fas fa-history"></i></span>
                                                    <span>Ver Historial de Pagados</span>
                                                </a>
                                            </div>
                                        </td>
                                    </tr>
                                {% endif %}
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Pagination -->
                    {% if paginator.num_pages > 1 %}
                    <div class="pagination" id="pagination">
                        {% if paginator.has_previous %}
                            <a href="?page={{ paginator.previous_page_number }}{% for key, value in filtros.items %}{% if value %}&{{ key }}={{ value }}{% endif %}{% endfor %}" 
                               class="page-btn"> Anterior</a>
                        {% endif %}
                        
                        <span class="page-info" id="pageInfo">
                            P谩gina {{ paginator.number }} de {{ paginator.num_pages }}
                        </span>
                        
                        {% if paginator.has_next %}
                            <a href="?page={{ paginator.next_page_number }}{% for key, value in filtros.items %}{% if value %}&{{ key }}={{ value }}{% endif %}{% endfor %}" 
                               class="page-btn">Siguiente </a>
                        {% endif %}
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal para ver detalles del pedido -->
    <div class="modal" id="orderModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Detalles del Pedido</h3>
                <button class="modal-close" onclick="closeModal()"></button>
            </div>
            <div class="modal-body" id="modalBody">
                <!-- Los detalles del pedido se cargar谩n din谩micamente -->
            </div>
        </div>
    </div>
    
    <!-- Modal para cambiar estado del pedido -->
    <div class="status-modal" id="statusModal">
        <div class="status-modal-content">
            <div class="status-modal-header">
                <h3>Cambiar Estado del Pedido</h3>
                <button class="modal-close" onclick="closeStatusModal()"></button>
            </div>
            <div class="status-modal-body" id="statusModalBody">
                <!-- Las opciones de estado se cargar谩n din谩micamente -->
            </div>
        </div>
    </div>
    
    <!-- Modal para editar pedido -->
    <div class="edit-modal" id="editModal">
        <div class="edit-modal-content">
            <div class="edit-modal-header">
                <h3>锔 Editar Pedido</h3>
                <button class="modal-close" onclick="closeEditModal()"></button>
            </div>
            <div class="edit-modal-body" id="editModalBody">
                <!-- El contenido se cargar谩 din谩micamente -->
            </div>
        </div>
    </div>
    
    <!-- Agregar CSRF token para las peticiones AJAX -->
    {% csrf_token %}

    <script>
      // Variables globales
let currentOrder = null;

// Inicializar la aplicaci贸n
document.addEventListener('DOMContentLoaded', function() {
    console.log('=== INICIANDO GESTIN DE PEDIDOS ===');
    
    setupEventListeners();
    
    // Si hay filtros aplicados, restaurarlos
    restoreFilters();
});

// Configurar event listeners
function setupEventListeners() {
    // Formatear ingresos del d铆a con formato RD
    const ingresosElement = document.getElementById('ingresosHoyValor');
    if (ingresosElement) {
        const valor = parseFloat(ingresosElement.textContent) || 0;
        ingresosElement.textContent = valor.toLocaleString('es-DO', {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        });
    }
    
    // Bot贸n para exportar pedidos
    const exportBtn = document.querySelector('.btn-primary[onclick*="exportOrders"]');
    if (exportBtn) {
        exportBtn.onclick = exportOrders;
    }
    
    // Formulario de filtros - enviar al cambiar
    const filterSelects = document.querySelectorAll('.filter-select');
    filterSelects.forEach(select => {
        select.addEventListener('change', function() {
            // Actualizar la URL con los filtros
            updateURLFilters();
        });
    });
    
    // Buscar al presionar Enter
    const searchInput = document.getElementById('searchInput');
    if (searchInput) {
        searchInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                updateURLFilters();
            }
        });
    }
}

// Restaurar filtros desde URL
function restoreFilters() {
    const urlParams = new URLSearchParams(window.location.search);
    
    const filters = {
        'search': urlParams.get('search') || '',
        'estado': urlParams.get('estado') || '',
        'tipo': urlParams.get('tipo') || '',
        'fecha': urlParams.get('fecha') || '',
        'sort': urlParams.get('sort') || 'fecha_desc'
    };
    
    // Establecer valores en los inputs
    Object.keys(filters).forEach(key => {
        const element = document.querySelector(`[name="${key}"]`);
        if (element && filters[key]) {
            element.value = filters[key];
        }
    });
}

// Actualizar URL con filtros
function updateURLFilters() {
    const form = document.getElementById('filterForm');
    const formData = new FormData(form);
    const params = new URLSearchParams();
    
    for (const [key, value] of formData.entries()) {
        if (value) {
            params.append(key, value);
        }
    }
    
    // Mantener el par谩metro de p谩gina si existe
    const currentParams = new URLSearchParams(window.location.search);
    const page = currentParams.get('page');
    if (page) {
        params.append('page', page);
    }
    
    // Actualizar URL y recargar
    window.location.href = `${window.location.pathname}?${params.toString()}`;
}

// Funci贸n para exportar pedidos
function exportOrders() {
    showNotification('Funcionalidad de exportaci贸n en desarrollo', 'info');
}

// Funci贸n para ver detalles del pedido
function viewOrderDetails(pedidoId) {
    console.log('Cargando detalles del pedido:', pedidoId);
    
    fetch(`/gestiondepedidos/detalle/${pedidoId}/`)
        .then(response => {
            if (!response.ok) {
                throw new Error(`Error ${response.status}: Pedido no encontrado`);
            }
            return response.json();
        })
        .then(pedido => {
            console.log('Detalles cargados:', pedido);
            cargarDetallesPedido(pedido);
            document.getElementById('orderModal').classList.add('active');
        })
        .catch(error => {
            console.error('Error al cargar pedido:', error);
            showNotification('Error: ' + error.message, 'error');
        });
}

// Funci贸n para cargar detalles en el modal
function cargarDetallesPedido(pedido) {
    const modalBody = document.getElementById('modalBody');
    
    // Formatear items
    let itemsHTML = '';
    if (pedido.items && pedido.items.length > 0) {
        itemsHTML = pedido.items.map(item => `
            <tr>
                <td>${item.name || item.nombre}</td>
                <td>${item.quantity || item.cantidad}</td>
                <td>$${(item.price || item.precio || 0).toLocaleString('es-DO', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                <td>$${(item.total || item.subtotal || 0).toLocaleString('es-DO', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
            </tr>
        `).join('');
    }
    
    // Determinar icono y color seg煤n estado
    const estadoInfo = getEstadoInfo(pedido.estado);
    const tipoInfo = getTipoInfo(pedido.tipo_pedido);
    
    modalBody.innerHTML = `
        <div style="background: white; border-radius: 15px; padding: 2rem;">
            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 2rem;">
                <div>
                    <h2 style="color: #2c3e50; margin-bottom: 0.5rem;">Pedido #${pedido.codigo_pedido}</h2>
                    <div style="color: #718096;">${pedido.fecha_pedido}</div>
                </div>
                <span class="status-badge ${estadoInfo.class}">
                    <span class="status-icon">${estadoInfo.icon}</span>
                    ${pedido.estado_display}
                </span>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 2rem;">
                <div>
                    <h4 style="color: #2c3e50; margin-bottom: 1rem;"><i class="fas fa-user"></i> Informaci贸n del Cliente</h4>
                    <div style="background: #f8f9ff; padding: 1rem; border-radius: 10px;">
                        <div style="margin-bottom: 0.5rem;">
                            <strong>Nombre:</strong> ${pedido.nombre_cliente || 'No especificado'}
                        </div>
                        ${pedido.telefono_cliente ? `
                            <div style="margin-bottom: 0.5rem;">
                                <strong>Tel茅fono:</strong> ${pedido.telefono_cliente}
                            </div>
                        ` : ''}
                        ${pedido.direccion_entrega ? `
                            <div style="margin-bottom: 0.5rem;">
                                <strong>Direcci贸n:</strong> ${pedido.direccion_entrega}
                            </div>
                        ` : ''}
                        <div style="margin-bottom: 0.5rem;">
                            <strong>Tipo:</strong> ${tipoInfo.icon} ${pedido.tipo_pedido_display}
                        </div>
                        ${pedido.mesa_numero ? `
                            <div style="margin-bottom: 0.5rem;">
                                <strong>Mesa:</strong> ${pedido.mesa_numero}
                            </div>
                        ` : ''}
                    </div>
                </div>
                
                <div>
                    <h4 style="color: #2c3e50; margin-bottom: 1rem;"><i class="fas fa-dollar-sign"></i> Resumen de Pago</h4>
                    <div style="background: #f8f9ff; padding: 1rem; border-radius: 10px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                            <span>Subtotal:</span>
                            <span>$${pedido.subtotal.toLocaleString('es-DO', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                            <span>Env铆o:</span>
                            <span>$${pedido.envio.toLocaleString('es-DO', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; font-weight: bold; font-size: 1.2rem; color: #ff7e5f; padding-top: 0.5rem; border-top: 1px solid #e0e6ff;">
                            <span>Total:</span>
                            <span>$${pedido.total.toLocaleString('es-DO', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div>
                <h4 style="color: #2c3e50; margin-bottom: 1rem;"><i class="fas fa-utensils"></i> Items del Pedido (${pedido.cantidad_items || pedido.items?.length || 0})</h4>
                <div style="overflow-x: auto;">
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%); color: white;">
                                <th style="padding: 1rem; text-align: left;">Producto</th>
                                <th style="padding: 1rem; text-align: center;">Cantidad</th>
                                <th style="padding: 1rem; text-align: right;">Precio Unitario</th>
                                <th style="padding: 1rem; text-align: right;">Subtotal</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${itemsHTML || `
                                <tr>
                                    <td colspan="4" style="padding: 2rem; text-align: center; color: #718096;">
                                        No hay items en este pedido
                                    </td>
                                </tr>
                            `}
                        </tbody>
                    </table>
                </div>
            </div>
            
            ${pedido.notas ? `
                <div style="margin-top: 2rem;">
                    <h4 style="color: #2c3e50; margin-bottom: 1rem;"><i class="fas fa-sticky-note"></i> Notas</h4>
                    <div style="background: #fff7ed; padding: 1rem; border-radius: 10px; border-left: 4px solid #ed8936;">
                        ${pedido.notas}
                    </div>
                </div>
            ` : ''}
            
            ${pedido.tiempo_preparacion ? `
                <div style="margin-top: 1rem; padding: 1rem; background: #e6fffa; border-radius: 10px; border-left: 4px solid #38a169;">
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <span><i class="fas fa-clock"></i></span>
                        <span><strong>Tiempo estimado de preparaci贸n:</strong> ${pedido.tiempo_preparacion}</span>
                    </div>
                </div>
            ` : ''}
            
            <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 2rem;">
                <button class="btn btn-warning" onclick="closeModal()">Cerrar</button>
                <button class="btn btn-info" onclick="openStatusModal(${pedido.id})">
                    <span><i class="fas fa-sync-alt"></i></span>
                    <span>Cambiar Estado</span>
                </button>
            </div>
        </div>
    `;
}

// Funci贸n para abrir modal de edici贸n
function openEditModal(pedidoId) {
    console.log('Abriendo modal para editar pedido:', pedidoId);
    
    fetch(`/gestiondepedidos/detalle/${pedidoId}/`)
        .then(response => {
            if (!response.ok) {
                throw new Error(`Error ${response.status}: Pedido no encontrado`);
            }
            return response.json();
        })
        .then(pedido => {
            console.log('Pedido cargado para edici贸n:', pedido);
            cargarDatosEdicion(pedido);
            document.getElementById('editModal').classList.add('active');
        })
        .catch(error => {
            console.error('Error al cargar pedido:', error);
            showNotification('Error: ' + error.message, 'error');
        });
}

// Funci贸n para cargar datos en el modal de edici贸n
function cargarDatosEdicion(pedido) {
    const modalBody = document.getElementById('editModalBody');
    
    // Formatear items actuales
    let itemsHTML = '';
    if (pedido.items && pedido.items.length > 0) {
        itemsHTML = pedido.items.map((item, index) => {
            // Asegurar que el ID sea string y est茅 disponible
            const itemId = item.id ? String(item.id) : '';
            return `
                <div class="order-item-edit" data-index="${index}" data-id="${itemId}">
                    <div style="flex: 2;">
                        <strong>${item.name || item.nombre}</strong>
                        <div style="font-size: 0.9rem; color: #718096;">
                            Precio: $${(item.price || item.precio || 0).toLocaleString('es-DO', {minimumFractionDigits: 2, maximumFractionDigits: 2})}
                        </div>
                    </div>
                    <div class="cantidad-controls">
                        <button type="button" class="cantidad-btn" onclick="cambiarCantidad(${index}, -1)">-</button>
                        <input type="number" class="cantidad-input" 
                               value="${item.quantity || item.cantidad || 1}" 
                               min="1" 
                               onchange="actualizarTotalItem(${index}, this.value)"
                               data-precio="${item.price || item.precio || 0}"
                               id="cantidad-${index}">
                        <button type="button" class="cantidad-btn" onclick="cambiarCantidad(${index}, 1)">+</button>
                    </div>
                    <div style="font-weight: bold; color: #ff7e5f; min-width: 80px; text-align: right;" id="total-item-${index}">
                        $${(item.total || item.subtotal || 0).toLocaleString('es-DO', {minimumFractionDigits: 2, maximumFractionDigits: 2})}
                    </div>
                    <button type="button" class="btn-icon btn-danger" onclick="eliminarItem(${index})" title="Eliminar item">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            `;
        }).join('');
    }
    
    modalBody.innerHTML = `
        <input type="hidden" id="editPedidoId" value="${pedido.id}">
        
        <div class="edit-form-group">
            <label><i class="fas fa-clipboard"></i> Informaci贸n del Pedido</label>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                <div>
                    <div style="font-weight: 600;">C贸digo:</div>
                    <div>${pedido.codigo_pedido}</div>
                </div>
                <div>
                    <div style="font-weight: 600;">Estado Actual:</div>
                    <div>
                        <span class="status-badge ${getEstadoClass(pedido.estado)}">
                            ${pedido.estado_display}
                        </span>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="edit-form-group">
            <label><i class="fas fa-user"></i> Informaci贸n del Cliente</label>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                <div>
                    <label for="editNombreCliente">Nombre *</label>
                    <input type="text" id="editNombreCliente" 
                           value="${pedido.nombre_cliente || ''}" 
                           placeholder="Nombre del cliente"
                           required>
                </div>
                <div>
                    <label for="editTelefonoCliente">Tel茅fono</label>
                    <input type="tel" id="editTelefonoCliente" 
                           value="${pedido.telefono_cliente || ''}" 
                           placeholder="Tel茅fono">
                </div>
            </div>
        </div>
        
        <div class="edit-form-group">
            <label><i class="fas fa-utensils"></i> Items del Pedido</label>
            <div id="itemsContainer" style="max-height: 300px; overflow-y: auto; padding: 0.5rem; border: 1px solid #e0e6ff; border-radius: 8px;">
                ${itemsHTML || '<p style="color: #718096; text-align: center; padding: 2rem;">No hay items en este pedido</p>'}
            </div>
        </div>
        
        <!-- Secci贸n para agregar nuevos productos -->
        <div class="edit-form-group">
            <label><i class="fas fa-plus-circle"></i> Agregar Nuevos Productos</label>
            
            <div class="search-bebidas" style="margin-bottom: 1rem;">
                <span class="search-bebidas-icon"><i class="fas fa-search"></i></span>
                <input type="text" id="buscarProducto" placeholder="Buscar bebidas, platos..." 
                       oninput="buscarProductosDisponibles()">
                <button type="button" class="search-bebidas-btn" onclick="buscarProductosDisponibles()">Buscar</button>
            </div>
            
            <div style="margin-bottom: 1rem;">
                <label for="tipoProducto">Tipo de Producto:</label>
                <select id="tipoProducto" onchange="buscarProductosDisponibles()" style="width: 100%; padding: 0.75rem;">
                    <option value="todos">Todos</option>
                    <option value="bebida">Bebidas</option>
                    <option value="plato">Platos</option>
                </select>
            </div>
            
            <div id="productosDisponibles" style="max-height: 200px; overflow-y: auto; border: 1px solid #e0e6ff; border-radius: 8px; padding: 0.5rem;">
                <p style="color: #718096; text-align: center; padding: 1rem;">Busca productos para agregar</p>
            </div>
        </div>
        
        <div class="edit-form-group">
            <label><i class="fas fa-sticky-note"></i> Notas Adicionales</label>
            <textarea id="editNotas" rows="3" placeholder="Notas del pedido...">${pedido.notas || ''}</textarea>
        </div>
        
        <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 2rem; padding-top: 1rem; border-top: 1px solid #e0e6ff;">
            <div>
                <strong style="font-size: 1.2rem;">Total: $</strong>
                <span id="totalPedidoEdit" style="font-size: 1.5rem; font-weight: bold; color: #ff7e5f;">
                    ${pedido.total.toLocaleString('es-DO', {minimumFractionDigits: 2, maximumFractionDigits: 2})}
                </span>
            </div>
            <div style="display: flex; gap: 1rem;">
                <button type="button" class="btn btn-warning" onclick="closeEditModal()">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="guardarCambiosPedido()">
                    <span><i class="fas fa-save"></i></span>
                    <span>Guardar Cambios</span>
                </button>
            </div>
        </div>
    `;
    
    // Inicializar b煤squeda de productos
    buscarProductosDisponibles();
}

// Funci贸n para buscar productos disponibles
function buscarProductosDisponibles() {
    const searchTerm = document.getElementById('buscarProducto')?.value || '';
    const tipoProducto = document.getElementById('tipoProducto')?.value || 'todos';
    
    console.log('Buscando productos:', searchTerm, tipoProducto);
    
    fetch(`/gestiondepedidos/platos-disponibles/?search=${encodeURIComponent(searchTerm)}&tipo=${tipoProducto}`)
        .then(response => {
            if (!response.ok) {
                throw new Error('Error en la respuesta del servidor');
            }
            return response.json();
        })
        .then(productos => {
            const container = document.getElementById('productosDisponibles');
            if (!container) return;
            
            if (!productos || productos.length === 0) {
                container.innerHTML = '<p style="color: #718096; text-align: center; padding: 1rem;">No se encontraron productos</p>';
                return;
            }
            
            container.innerHTML = productos.map(producto => `
                <div class="producto-item" style="padding: 0.75rem; border-bottom: 1px solid #f1f1f1; cursor: pointer; transition: background-color 0.2s;" 
                     onclick="agregarProductoAPedido(${JSON.stringify(producto).replace(/"/g, '&quot;')})"
                     onmouseover="this.style.backgroundColor='#f8f9ff'"
                     onmouseout="this.style.backgroundColor='transparent'">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div style="flex: 1;">
                            <strong>${producto.nombre}</strong>
                            <div style="font-size: 0.85rem; color: #718096;">
                                ${producto.categoria || producto.tipo} - $${producto.precio.toLocaleString('es-DO', {minimumFractionDigits: 2, maximumFractionDigits: 2})}
                            </div>
                        </div>
                        <div style="margin-left: 1rem;">
                            <span style="color: #38a169; font-size: 1.2rem;"><i class="fas fa-plus-circle"></i></span>
                        </div>
                    </div>
                    ${producto.cantidad_disponible !== null && producto.cantidad_disponible !== undefined ? `
                        <div class="stock-indicator" style="margin-top: 0.25rem;">
                            <span class="stock-icon ${producto.stock_status === 'high' ? 'stock-high' : producto.stock_status === 'medium' ? 'stock-medium' : 'stock-low'}">
                                ${producto.stock_icon || '<i class="fas fa-box"></i>'}
                            </span>
                            <span class="stock-text">${producto.stock_label || 'Disponible'}</span>
                        </div>
                    ` : ''}
                </div>
            `).join('');
        })
        .catch(error => {
            console.error('Error al buscar productos:', error);
            const container = document.getElementById('productosDisponibles');
            if (container) {
                container.innerHTML = '<p style="color: #e53e3e; text-align: center; padding: 1rem;">Error al cargar productos</p>';
            }
        });
}

// Funci贸n para agregar producto al pedido
function agregarProductoAPedido(producto) {
    const itemsContainer = document.getElementById('itemsContainer');
    
    // Si el contenedor est谩 vac铆o, limpiar el mensaje
    if (itemsContainer.innerHTML.includes('No hay items')) {
        itemsContainer.innerHTML = '';
    }
    
    // Crear nuevo item con ID 煤nico
    const itemUniqueId = `item-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
    const precio = parseFloat(producto.precio) || 0;
    const cantidad = 1;
    const total = precio * cantidad;
    
    const nuevoItemHTML = `
        <div class="order-item-edit" data-id="${producto.id}" data-unique-id="${itemUniqueId}">
            <div style="flex: 2;">
                <strong>${producto.nombre}</strong>
                <div style="font-size: 0.9rem; color: #718096;">
                    Precio: $${precio.toLocaleString('es-DO', {minimumFractionDigits: 2, maximumFractionDigits: 2})}
                </div>
            </div>
            <div class="cantidad-controls">
                <button type="button" class="cantidad-btn" onclick="cambiarCantidadEdit('${itemUniqueId}', -1)">-</button>
                <input type="number" class="cantidad-input" 
                       value="${cantidad}" 
                       min="1" 
                       onchange="actualizarTotalItemEdit('${itemUniqueId}', this.value)"
                       data-precio="${precio}"
                       id="cantidad-input-${itemUniqueId}">
                <button type="button" class="cantidad-btn" onclick="cambiarCantidadEdit('${itemUniqueId}', 1)">+</button>
            </div>
            <div style="font-weight: bold; color: #ff7e5f; min-width: 80px; text-align: right;" id="total-item-${itemUniqueId}">
                $${total.toLocaleString('es-DO', {minimumFractionDigits: 2, maximumFractionDigits: 2})}
            </div>
            <button type="button" class="btn-icon btn-danger" onclick="eliminarItemEdit('${itemUniqueId}')" title="Eliminar item" style="margin-left: 1rem;">
                <i class="fas fa-trash"></i>
            </button>
        </div>
    `;
    
    itemsContainer.innerHTML += nuevoItemHTML;
    calcularTotalPedidoEdit();
    
    showNotification(`<i class="fas fa-check-circle"></i> ${producto.nombre} agregado al pedido`, 'success');
}

// Funci贸n para cambiar cantidad (edici贸n - items nuevos)
function cambiarCantidadEdit(itemUniqueId, cambio) {
    const input = document.getElementById(`cantidad-input-${itemUniqueId}`);
    if (!input) return;
    
    let nuevaCantidad = parseInt(input.value) + cambio;
    if (nuevaCantidad < 1) nuevaCantidad = 1;
    
    input.value = nuevaCantidad;
    actualizarTotalItemEdit(itemUniqueId, nuevaCantidad);
}

// Funci贸n para actualizar total de item (edici贸n - items nuevos)
function actualizarTotalItemEdit(itemUniqueId, cantidad) {
    const input = document.getElementById(`cantidad-input-${itemUniqueId}`);
    if (!input) return;
    
    const precio = parseFloat(input.dataset.precio) || 0;
    const total = precio * parseInt(cantidad);
    
    const totalElement = document.getElementById(`total-item-${itemUniqueId}`);
    if (totalElement) {
        totalElement.textContent = `$${total.toLocaleString('es-DO', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
    }
    
    calcularTotalPedidoEdit();
}

// Funci贸n para eliminar item (edici贸n - items nuevos)
function eliminarItemEdit(itemUniqueId) {
    const itemDiv = document.querySelector(`.order-item-edit[data-unique-id="${itemUniqueId}"]`);
    if (itemDiv && confirm('驴Est谩s seguro de eliminar este item?')) {
        itemDiv.remove();
        calcularTotalPedidoEdit();
        
        // Si no quedan items, mostrar mensaje
        const itemsContainer = document.getElementById('itemsContainer');
        if (itemsContainer.children.length === 0) {
            itemsContainer.innerHTML = '<p style="color: #718096; text-align: center; padding: 2rem;">No hay items en este pedido</p>';
        }
    }
}

// Funci贸n para calcular total del pedido (edici贸n)
function calcularTotalPedidoEdit() {
    let total = 0;
    
    document.querySelectorAll('.order-item-edit').forEach(item => {
        const totalText = item.querySelector('div[style*="color: #ff7e5f"]').textContent;
        const itemTotal = parseFloat(totalText.replace('$', '')) || 0;
        total += itemTotal;
    });
    
    const totalElement = document.getElementById('totalPedidoEdit');
    if (totalElement) {
        totalElement.textContent = total.toLocaleString('es-DO', {minimumFractionDigits: 2, maximumFractionDigits: 2});
    }
    
    return total;
}

// Funci贸n para cambiar cantidad (items originales)
function cambiarCantidad(index, cambio) {
    const input = document.getElementById(`cantidad-${index}`);
    if (!input) return;
    
    let nuevaCantidad = parseInt(input.value) + cambio;
    if (nuevaCantidad < 1) nuevaCantidad = 1;
    
    input.value = nuevaCantidad;
    actualizarTotalItem(index, nuevaCantidad);
}

// Funci贸n para actualizar total de item (items originales)
function actualizarTotalItem(index, cantidad) {
    const input = document.getElementById(`cantidad-${index}`);
    if (!input) return;
    
    const precio = parseFloat(input.dataset.precio) || 0;
    const total = precio * parseInt(cantidad);
    
    const totalElement = document.getElementById(`total-item-${index}`);
    if (totalElement) {
        totalElement.textContent = `$${total.toLocaleString('es-DO', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
    }
    
    calcularTotalPedidoEdit();
}

// Funci贸n para eliminar item (items originales)
function eliminarItem(index) {
    const itemDiv = document.querySelector(`.order-item-edit[data-index="${index}"]`);
    if (itemDiv && confirm('驴Est谩s seguro de eliminar este item?')) {
        itemDiv.remove();
        calcularTotalPedidoEdit();
        
        // Si no quedan items, mostrar mensaje
        const itemsContainer = document.getElementById('itemsContainer');
        if (itemsContainer.children.length === 0) {
            itemsContainer.innerHTML = '<p style="color: #718096; text-align: center; padding: 2rem;">No hay items en este pedido</p>';
        }
    }
}

// Funci贸n para guardar cambios del pedido
function guardarCambiosPedido() {
    const pedidoId = document.getElementById('editPedidoId').value;
    const nombreCliente = document.getElementById('editNombreCliente').value;
    const telefonoCliente = document.getElementById('editTelefonoCliente').value;
    const notas = document.getElementById('editNotas').value;
    
    // Validar nombre del cliente
    if (!nombreCliente.trim()) {
        showNotification('<i class="fas fa-exclamation-circle"></i> El nombre del cliente es obligatorio', 'error');
        document.getElementById('editNombreCliente').focus();
        return;
    }
    
    // Recopilar todos los items con su ID
    const items = [];
    document.querySelectorAll('.order-item-edit').forEach(itemDiv => {
        const id = itemDiv.getAttribute('data-id'); // Obtener el ID del producto (PROD-XX o PLATO-XX)
        const nombre = itemDiv.querySelector('strong').textContent;
        const cantidadInput = itemDiv.querySelector('.cantidad-input');
        const cantidad = parseInt(cantidadInput.value) || 1;
        const precio = parseFloat(cantidadInput.dataset.precio) || 0;
        const total = precio * cantidad;
        
        items.push({
            id: id,  //  Enviar el ID del producto
            name: nombre,
            quantity: cantidad,
            price: precio,
            total: total
        });
    });
    
    // Validar que haya al menos un item
    if (items.length === 0) {
        showNotification('<i class="fas fa-exclamation-circle"></i> El pedido debe tener al menos un item', 'error');
        return;
    }
    
    console.log('Items a enviar:', items);
    
    // Preparar datos para enviar
    const formData = new FormData();
    formData.append('nuevos_items', JSON.stringify(items));
    formData.append('nombre_cliente', nombreCliente);
    formData.append('telefono_cliente', telefonoCliente);
    formData.append('notas', notas);
    
    // Agregar CSRF token
    const csrfToken = getCSRFToken();
    if (csrfToken) {
        formData.append('csrfmiddlewaretoken', csrfToken);
    }
    
    console.log('Enviando datos para editar pedido:', {
        pedidoId,
        nombreCliente,
        telefonoCliente,
        cantidadItems: items.length,
        items: items,
        total: calcularTotalPedidoEdit()
    });
    
    // Mostrar indicador de carga
    const saveBtn = document.querySelector('.btn-primary[onclick="guardarCambiosPedido()"]');
    const originalText = saveBtn.innerHTML;
    saveBtn.innerHTML = '<span><i class="fas fa-hourglass-half"></i></span><span>Guardando...</span>';
    saveBtn.disabled = true;
    
    // Enviar datos al servidor
    fetch(`/gestiondepedidos/editar/${pedidoId}/`, {
        method: 'POST',
        body: formData,
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`Error ${response.status}: ${response.statusText}`);
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            showNotification(`<i class="fas fa-check-circle"></i> ${data.mensaje}`, 'success');
            closeEditModal();
            
            // Recargar la p谩gina despu茅s de un breve retraso
            setTimeout(() => {
                location.reload();
            }, 1500);
        } else {
            throw new Error(data.error || 'Error desconocido');
        }
    })
    .catch(error => {
        console.error('Error al guardar cambios:', error);
        showNotification(`<i class="fas fa-exclamation-circle"></i> Error: ${error.message}`, 'error');
        
        // Restaurar bot贸n
        saveBtn.innerHTML = originalText;
        saveBtn.disabled = false;
    });
}

// Funci贸n para abrir modal de cambio de estado
function openStatusModal(pedidoId) {
    currentOrder = pedidoId;
    
    const estados = [
        { value: 'pendiente', label: 'Pendiente', icon: '<i class="fas fa-clock"></i>', description: 'El pedido est谩 pendiente de confirmaci贸n' },
        { value: 'confirmado', label: 'Confirmado', icon: '<i class="fas fa-check"></i>', description: 'El pedido ha sido confirmado' },
        { value: 'preparacion', label: 'En Preparaci贸n', icon: '<i class="fas fa-concierge-bell"></i>', description: 'El pedido est谩 siendo preparado' },
        { value: 'listo', label: 'Listo', icon: '<i class="fas fa-rocket"></i>', description: 'El pedido est谩 listo para servir/entregar' },
        { value: 'entregado', label: 'Entregado', icon: '<i class="fas fa-box"></i>', description: 'El pedido ha sido entregado' },
        { value: 'completado', label: 'Completado', icon: '<i class="fas fa-flag-checkered"></i>', description: 'El pedido ha sido completado' },
        { value: 'cancelado', label: 'Cancelado', icon: '<i class="fas fa-times-circle"></i>', description: 'El pedido ha sido cancelado' }
    ];
    
    const modalBody = document.getElementById('statusModalBody');
    modalBody.innerHTML = `
        <input type="hidden" id="statusPedidoId" value="${pedidoId}">
        
        <div style="margin-bottom: 1.5rem;">
            <p>Selecciona el nuevo estado para el pedido:</p>
        </div>
        
        <div id="statusOptions">
            ${estados.map(estado => `
                <div class="status-option" data-value="${estado.value}" onclick="seleccionarEstado('${estado.value}')">
                    <div class="status-option-icon">
                        ${estado.icon}
                    </div>
                    <div class="status-option-label">
                        <div>${estado.label}</div>
                        <div style="font-size: 0.85rem; color: #718096; font-weight: normal;">${estado.description}</div>
                    </div>
                </div>
            `).join('')}
        </div>
        
        <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 2rem;">
            <button class="btn btn-warning" onclick="closeStatusModal()">Cancelar</button>
            <button class="btn btn-primary" id="confirmStatusBtn" onclick="confirmarCambioEstado()" disabled>
                <span><i class="fas fa-save"></i></span>
                <span>Confirmar Cambio</span>
            </button>
        </div>
    `;
    
    document.getElementById('statusModal').classList.add('active');
}

// Funci贸n para seleccionar estado
function seleccionarEstado(estadoValue) {
    // Remover selecci贸n anterior
    document.querySelectorAll('.status-option').forEach(option => {
        option.classList.remove('selected');
    });
    
    // Marcar como seleccionado
    const selectedOption = document.querySelector(`.status-option[data-value="${estadoValue}"]`);
    if (selectedOption) {
        selectedOption.classList.add('selected');
    }
    
    // Habilitar bot贸n de confirmaci贸n
    document.getElementById('confirmStatusBtn').disabled = false;
}

// Funci贸n para confirmar cambio de estado
function confirmarCambioEstado() {
    const pedidoId = currentOrder;
    const selectedOption = document.querySelector('.status-option.selected');
    
    if (!selectedOption) {
        showNotification('<i class="fas fa-times-circle"></i> Por favor selecciona un estado', 'error');
        return;
    }
    
    const nuevoEstado = selectedOption.dataset.value;
    
    if (!confirm(`驴Est谩s seguro de cambiar el estado del pedido a "${selectedOption.querySelector('.status-option-label div').textContent}"?`)) {
        return;
    }
    
    // Preparar datos
    const formData = new FormData();
    formData.append('estado', nuevoEstado);
    
    const csrfToken = getCSRFToken();
    if (csrfToken) {
        formData.append('csrfmiddlewaretoken', csrfToken);
    }
    
    // Mostrar indicador de carga
    const confirmBtn = document.getElementById('confirmStatusBtn');
    const originalText = confirmBtn.innerHTML;
    confirmBtn.innerHTML = '<span><i class="fas fa-hourglass-half"></i></span><span>Cambiando...</span>';
    confirmBtn.disabled = true;
    
    // Enviar solicitud
    fetch(`/gestiondepedidos/cambiar-estado/${pedidoId}/`, {
        method: 'POST',
        body: formData,
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification(`<i class="fas fa-check-circle"></i> Estado cambiado a ${data.estado_display}`, 'success');
            closeStatusModal();
            
            // Actualizar la fila en la tabla
            const row = document.querySelector(`tr[data-order-id="${pedidoId}"]`);
            if (row) {
                const estadoCell = row.querySelector('td:nth-child(7)');
                if (estadoCell) {
                    const estadoInfo = getEstadoInfo(nuevoEstado);
                    estadoCell.innerHTML = `
                        <span class="status-badge ${estadoInfo.class}">
                            <span class="status-icon">${estadoInfo.icon}</span>
                            ${data.estado_display}
                        </span>
                    `;
                }
            }
            
            // Actualizar estad铆sticas
            updateStats();
        } else {
            throw new Error(data.error || 'Error desconocido');
        }
    })
    .catch(error => {
        console.error('Error al cambiar estado:', error);
        showNotification(`<i class="fas fa-exclamation-circle"></i> Error: ${error.message}`, 'error');
        
        // Restaurar bot贸n
        confirmBtn.innerHTML = originalText;
        confirmBtn.disabled = false;
    });
}

// Funci贸n para eliminar pedido
function deleteOrder(pedidoId) {
    if (!confirm('驴Est谩s seguro de eliminar este pedido? Esta acci贸n no se puede deshacer.')) {
        return;
    }
    
    // Preparar datos
    const formData = new FormData();
    formData.append('eliminar_vista', 'true');
    
    const csrfToken = getCSRFToken();
    if (csrfToken) {
        formData.append('csrfmiddlewaretoken', csrfToken);
    }
    
    // Enviar solicitud
    fetch(`/gestiondepedidos/eliminar/${pedidoId}/`, {
        method: 'POST',
        body: formData,
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification(`<i class="fas fa-check-circle"></i> ${data.mensaje}`, 'success');
            
            // Eliminar la fila de la tabla
            const row = document.querySelector(`tr[data-order-id="${pedidoId}"]`);
            if (row) {
                row.remove();
            }
            
            // Actualizar estad铆sticas
            updateStats();
            
            // Mostrar mensaje si no hay pedidos
            const tbody = document.querySelector('#pedidosBody');
            if (tbody && tbody.children.length === 0) {
                tbody.innerHTML = `
                    <tr class="empty-state">
                        <td colspan="8">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
                            </svg>
                            <h3>No se encontraron pedidos</h3>
                            <p>Todos los pedidos est谩n pagados o no hay pedidos con los filtros aplicados</p>
                            <div style="margin-top: 1rem;">
                                <a href="{% url 'historial_pedidos' %}" class="btn btn-success" style="text-decoration: none;">
                                    <span><i class="fas fa-history"></i></span>
                                    <span>Ver Historial de Pagados</span>
                                </a>
                            </div>
                        </td>
                    </tr>
                `;
            }
        } else {
            throw new Error(data.error || 'Error al eliminar el pedido');
        }
    })
    .catch(error => {
        console.error('Error al eliminar pedido:', error);
        showNotification(`<i class="fas fa-exclamation-circle"></i> ${error.message}`, 'error');
    });
}

// Funci贸n para actualizar estad铆sticas
function updateStats() {
    // Contar pedidos en la tabla
    const totalRows = document.querySelectorAll('#pedidosTable tbody tr:not(.empty-state)').length;
    const totalElement = document.getElementById('totalPedidos');
    if (totalElement) {
        totalElement.textContent = totalRows;
    }
    
    // Contar pedidos pendientes
    const pendientes = document.querySelectorAll('.status-pendiente').length;
    const pendientesElement = document.getElementById('pedidosPendientes');
    if (pendientesElement) {
        pendientesElement.textContent = pendientes;
    }
}

// Funciones de utilidad
function getCSRFToken() {
    const token = document.querySelector('[name=csrfmiddlewaretoken]');
    return token ? token.value : '';
}

function showNotification(message, type = 'success') {
    // Remover notificaciones anteriores
    const existing = document.querySelectorAll('.custom-notification');
    existing.forEach(n => n.remove());
    
    // Crear notificaci贸n
    const notification = document.createElement('div');
    notification.className = 'custom-notification';
    
    const colors = {
        success: { bg: '#38a169', color: '#ffffff' },
        error: { bg: '#e53e3e', color: '#ffffff' },
        info: { bg: '#3182ce', color: '#ffffff' },
        warning: { bg: '#d69e2e', color: '#ffffff' }
    };
    
    const color = colors[type] || colors.success;
    
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: ${color.bg};
        color: ${color.color};
        padding: 1rem 1.5rem;
        border-radius: 10px;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        z-index: 10000;
        animation: slideIn 0.3s ease-out;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 10px;
        max-width: 400px;
        white-space: pre-line;
    `;
    
    notification.innerHTML = message;
    document.body.appendChild(notification);
    
    // Animaciones CSS para notificaciones
    if (!document.querySelector('#notification-styles')) {
        const style = document.createElement('style');
        style.id = 'notification-styles';
        style.textContent = `
            @keyframes slideIn {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            @keyframes slideOut {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(100%); opacity: 0; }
            }
        `;
        document.head.appendChild(style);
    }
    
    // Remover despu茅s de 5 segundos
    setTimeout(() => {
        notification.style.animation = 'slideOut 0.3s ease-out';
        setTimeout(() => notification.remove(), 300);
    }, 5000);
}

function getEstadoClass(estado) {
    const clases = {
        'pendiente': 'status-pendiente',
        'confirmado': 'status-pendiente',
        'preparacion': 'status-preparacion',
        'listo': 'status-listo',
        'entregado': 'status-entregado',
        'completado': 'status-entregado',
        'cancelado': 'status-cancelado'
    };
    return clases[estado] || 'status-pendiente';
}

function getEstadoInfo(estado) {
    const info = {
        'pendiente': { class: 'status-pendiente', icon: '<i class="fas fa-clock"></i>' },
        'confirmado': { class: 'status-pendiente', icon: '<i class="fas fa-check"></i>' },
        'preparacion': { class: 'status-preparacion', icon: '<i class="fas fa-concierge-bell"></i>' },
        'listo': { class: 'status-listo', icon: '<i class="fas fa-rocket"></i>' },
        'entregado': { class: 'status-entregado', icon: '<i class="fas fa-box"></i>' },
        'completado': { class: 'status-entregado', icon: '<i class="fas fa-flag-checkered"></i>' },
        'cancelado': { class: 'status-cancelado', icon: '<i class="fas fa-times-circle"></i>' }
    };
    return info[estado] || { class: 'status-pendiente', icon: '<i class="fas fa-question-circle"></i>' };
}

function getTipoInfo(tipo) {
    const info = {
        'restaurante': { icon: '<i class="fas fa-utensils"></i>', label: 'Restaurante' },
        'domicilio': { icon: '<i class="fas fa-truck"></i>', label: 'Domicilio' },
        'recoger': { icon: '<i class="fas fa-walking"></i>', label: 'Recoger' },
        'mesa': { icon: '<i class="fas fa-utensils"></i>', label: 'Mesa' },
        'delivery': { icon: '<i class="fas fa-truck"></i>', label: 'Delivery' },
        'llevar': { icon: '<i class="fas fa-walking"></i>', label: 'Para llevar' }
    };
    return info[tipo] || { icon: '<i class="fas fa-box"></i>', label: tipo };
}

// Funciones para cerrar modales
function closeModal() {
    document.getElementById('orderModal').classList.remove('active');
}

function closeStatusModal() {
    document.getElementById('statusModal').classList.remove('active');
    currentOrder = null;
}

function closeEditModal() {
    document.getElementById('editModal').classList.remove('active');
}

// Funci贸n para alternar sidebar
function toggleSidebar() {
    const sidebar = document.getElementById('sidebar');
    const overlay = document.getElementById('sidebarOverlay');
    sidebar.classList.toggle('open');
    overlay.classList.toggle('open');
}

// Cerrar sidebar al hacer clic en overlay
document.getElementById('sidebarOverlay').addEventListener('click', toggleSidebar);

// A帽adir animaciones CSS para notificaciones si no existen
if (!document.querySelector('#notification-styles')) {
    const style = document.createElement('style');
    style.id = 'notification-styles';
    style.textContent = `
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        @keyframes slideOut {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }
    `;
    document.head.appendChild(style);
}

console.log(' JavaScript de gesti贸n de pedidos cargado correctamente');
    </script>
</body>
</html>