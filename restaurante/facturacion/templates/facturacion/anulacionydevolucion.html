<!DOCTYPE html>
{% load static %}
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Devoluciones - Buscar Factura</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #ff7e5f 0%, #feb47b 100%);
            min-height: 100vh;
        }
        
        /* App container */
        .app-container {
            display: flex;
            min-height: 100vh;
        }
        
        /* Sidebar styles */
        .sidebar {
            width: 260px;
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.2);
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
            position: fixed;
            top: 0;
            left: 0;
            bottom: 0;
            z-index: 1000;
        }
        
        .sidebar-header {
            background: linear-gradient(135deg, #ff7e5f 0%, #feb47b 100%);
            color: white;
            padding: 1.5rem;
            font-size: 1.25rem;
            font-weight: bold;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        
        .sidebar-nav {
            flex: 1;
            padding: 1rem 0;
            overflow-y: auto;
        }
        
        .nav-item {
            padding: 1rem 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            color: #ecf0f1;
            text-decoration: none;
            transition: all 0.3s;
            cursor: pointer;
            border-left: 3px solid transparent;
        }
        
        .nav-item:hover {
            background: rgba(255, 255, 255, 0.1);
            border-left-color: #ff7e5f;
            color: #ff7e5f;
            transform: translateX(5px);
        }
        
        .nav-item.active {
            background: rgba(255, 255, 255, 0.15);
            border-left-color: #ff7e5f;
            color: #ff7e5f;
            font-weight: 600;
        }
        
        .nav-icon {
            font-size: 1.25rem;
        }
        
        /* Mobile menu toggle */
        .menu-toggle {
            display: none;
            position: fixed;
            top: 1rem;
            left: 1rem;
            z-index: 1100;
            background: #ff7e5f;
            border: none;
            padding: 0.75rem;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            cursor: pointer;
            font-size: 1.5rem;
            color: white;
            transition: all 0.3s;
        }
        
        .menu-toggle:hover {
            background: #ff6b4a;
            transform: scale(1.05);
        }
        
        .sidebar-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
        }
        
        /* Main content area */
        .main-content {
            flex: 1;
            padding: 2rem;
            margin-left: 260px;
            transition: margin-left 0.3s ease;
        }
        
        .container {
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 25px;
            box-shadow: 0 25px 70px rgba(0, 0, 0, 0.25);
            overflow: hidden;
            animation: fadeIn 0.5s ease-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Header */
        .header {
            background: linear-gradient(135deg, #ff7e5f 0%, #feb47b 100%);
            color: white;
            padding: 2.5rem;
            text-align: center;
            position: relative;
            overflow: hidden;
        }
        
        .header::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100" preserveAspectRatio="none"><path d="M0,0 L100,0 L100,100 Z" fill="rgba(255,255,255,0.1)"/></svg>');
            background-size: cover;
        }
        
        .header h1 {
            font-size: 2.2rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            position: relative;
            z-index: 1;
        }
        
        .header p {
            opacity: 0.95;
            font-size: 1.1rem;
            position: relative;
            z-index: 1;
        }
        
        .content {
            padding: 2.5rem;
        }
        
        /* Search Section */
        .search-section {
            background: linear-gradient(135deg, #f8f9ff 0%, #ffffff 100%);
            padding: 2.5rem;
            border-radius: 20px;
            margin-bottom: 2rem;
            box-shadow: 0 10px 30px rgba(255, 126, 95, 0.1);
            border: 1px solid rgba(255, 126, 95, 0.1);
            text-align: center;
        }
        
        .search-title {
            color: #2c3e50;
            font-size: 1.8rem;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }
        
        .search-box {
            display: flex;
            gap: 0.75rem;
            max-width: 700px;
            margin: 0 auto 1rem;
            align-items: stretch;
        }
        
        .invoice-input {
            flex: 1;
            padding: 1.2rem;
            border: 3px solid #e0e6ff;
            border-radius: 15px;
            font-size: 1.2rem;
            font-weight: 600;
            text-align: center;
            transition: all 0.3s;
            background: white;
            box-shadow: 0 5px 15px rgba(50, 50, 93, 0.1);
        }
        
        .invoice-input:focus {
            outline: none;
            border-color: #ff7e5f;
            box-shadow: 0 0 0 5px rgba(255, 126, 95, 0.2);
        }
        
        /* Buttons */
        .btn {
            padding: 1rem 1.8rem;
            border: none;
            border-radius: 15px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            white-space: nowrap;
            text-decoration: none;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #ff7e5f 0%, #feb47b 100%);
            color: white;
            box-shadow: 0 10px 20px rgba(255, 126, 95, 0.3);
        }
        
        .btn-primary:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 25px rgba(255, 126, 95, 0.4);
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }
        
        .btn-secondary:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 25px rgba(102, 126, 234, 0.4);
        }
        
        /* Quick Action Button */
        .btn-quick-action {
            padding: 1rem 1.5rem;
            border: none;
            border-radius: 15px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            background: linear-gradient(135deg, #f0f0f0 0%, #e8e8e8 100%);
            color: #2c3e50;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            white-space: nowrap;
            text-decoration: none;
        }
        
        .btn-quick-action:hover {
            background: linear-gradient(135deg, #ff7e5f 0%, #feb47b 100%);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(255, 126, 95, 0.3);
        }
        
        .btn-quick-action:active {
            transform: translateY(0);
        }
        
        /* Invoice Display */
        .invoice-display {
            display: block;
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            animation: fadeIn 0.5s ease-out;
            margin-bottom: 2rem;
        }
        
        .invoice-header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 2rem;
        }
        
        .invoice-header-info {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1.5rem;
        }
        
        .invoice-title {
            font-size: 1.8rem;
            font-weight: 700;
        }
        
        .invoice-meta {
            text-align: right;
        }
        
        .invoice-meta div {
            margin-bottom: 0.5rem;
        }
        
        .invoice-status {
            display: inline-block;
            padding: 0.5rem 1.5rem;
            border-radius: 25px;
            font-weight: 600;
            font-size: 0.9rem;
            margin-top: 0.5rem;
        }
        
        .status-pagada, .status-pagado {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
        }
        
        .status-pendiente {
            background: linear-gradient(135deg, #ffd700 0%, #ffcc33 100%);
            color: #7c2d12;
        }
        
        .status-anulada, .status-anulado {
            background: linear-gradient(135deg, #ff416c 0%, #ff4b2b 100%);
        }
        
        .status-parcialmente_devuelta {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .status-totalmente_devuelta {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }
        
        .invoice-customer {
            background: #f8f9ff;
            padding: 1.5rem;
            border-radius: 15px;
            margin-top: 1rem;
        }
        
        .invoice-customer h4 {
            margin-bottom: 1rem;
            color: #2c3e50;
        }
        
        .customer-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }
        
        .customer-info div {
            margin-bottom: 0.5rem;
        }
        
        /* Invoice Items Table */
        .invoice-items {
            padding: 2rem;
        }
        
        .invoice-items h3 {
            color: #2c3e50;
            margin-bottom: 1.5rem;
            font-size: 1.5rem;
        }
        
        .items-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 2rem;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
        }
        
        .items-table thead {
            background: linear-gradient(135deg, #ff7e5f 0%, #feb47b 100%);
            color: white;
        }
        
        .items-table th {
            padding: 1.2rem 1rem;
            text-align: left;
            font-weight: 600;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .items-table tbody tr {
            border-bottom: 1px solid #e0e6ff;
            transition: background 0.3s;
        }
        
        .items-table tbody tr:hover {
            background: #f8f9ff;
        }
        
        .items-table td {
            padding: 1.2rem 1rem;
            color: #4a5568;
        }
        
        .items-table td:nth-child(2) {
            font-weight: 600;
            color: #2c3e50;
        }
        
        .items-table td:last-child {
            font-weight: 700;
            color: #ff7e5f;
        }
        
        /* Invoice Summary */
        .invoice-summary {
            background: #f8f9ff;
            padding: 2rem;
            border-radius: 15px;
        }
        
        .summary-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 1rem;
            font-size: 1.1rem;
        }
        
        .summary-total {
            font-size: 1.5rem;
            font-weight: 700;
            color: #2c3e50;
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 2px solid #e0e6ff;
        }
        
        .total-amount {
            color: #4CAF50;
            font-size: 1.8rem;
        }
        
        /* Return Actions */
        .return-actions {
            padding: 2rem;
            text-align: center;
            border-top: 1px solid #e0e6ff;
        }
        
        .return-actions h3 {
            color: #2c3e50;
            margin-bottom: 1.5rem;
        }
        
        .action-buttons {
            display: flex;
            gap: 1rem;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .btn-return {
            padding: 1.25rem 2.5rem;
            border: none;
            border-radius: 12px;
            font-weight: 700;
            font-size: 1.05rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        
        .btn-return.full {
            background: linear-gradient(135deg, #ff416c 0%, #ff4b2b 100%);
            color: white;
            flex: 1.2;
        }
        
        .btn-return.partial {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            flex: 1;
        }
        
        .btn-return.exchange {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            color: white;
            flex: 1;
        }
        
        .btn-return:hover:not(:disabled) {
            transform: translateY(-4px);
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.25);
        }
        
        .btn-return:active:not(:disabled) {
            transform: translateY(-2px);
        }
        
        .btn-return:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }
        
        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 3rem;
            color: #a0aec0;
        }
        
        .empty-state svg {
            width: 100px;
            height: 100px;
            margin-bottom: 1.5rem;
            opacity: 0.5;
        }
        
        /* Messages/Alerts */
        .messages-container {
            margin-bottom: 1.5rem;
        }
        
        .alert {
            padding: 1rem 1.5rem;
            border-radius: 10px;
            margin-bottom: 1rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
            animation: slideIn 0.3s ease-out;
        }
        
        .alert-success {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            color: white;
        }
        
        .alert-error {
            background: linear-gradient(135deg, #ff416c 0%, #ff4b2b 100%);
            color: white;
        }
        
        .alert-info {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
        }
        
        .alert-warning {
            background: linear-gradient(135deg, #ffd700 0%, #ffcc33 100%);
            color: #7c2d12;
        }
        
        /* Modal de Devolución Parcial */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }
        
        .modal-overlay.active {
            display: flex;
        }
        
        .modal-content-partial {
            background: white;
            border-radius: 20px;
            box-shadow: 0 25px 70px rgba(0, 0, 0, 0.3);
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            animation: slideDown 0.3s ease-out;
        }
        
        @keyframes slideDown {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .modal-header-partial {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-radius: 20px 20px 0 0;
        }
        
        .modal-header-partial h2 {
            margin: 0;
            font-size: 1.5rem;
        }
        
        .modal-close {
            background: rgba(255, 255, 255, 0.3);
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0.5rem 0.75rem;
            border-radius: 8px;
            transition: all 0.3s;
        }
        
        .modal-close:hover {
            background: rgba(255, 255, 255, 0.5);
        }
        
        .modal-body-partial {
            padding: 2rem;
        }
        
        .product-list {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        
        .product-item-wrapper {
            display: flex;
            align-items: center;
            gap: 1.5rem;
            padding: 1.25rem;
            background: linear-gradient(135deg, #f8f9ff 0%, #f0f4ff 100%);
            border-radius: 12px;
            border: 2px solid #e0e6ff;
            transition: all 0.3s;
        }
        
        .product-item-wrapper:hover {
            border-color: #667eea;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.15);
        }
        
        .product-item {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 0;
            background: transparent;
            border: none;
            cursor: pointer;
        }
        
        .product-item input[type="checkbox"] {
            width: 22px;
            height: 22px;
            cursor: pointer;
            accent-color: #667eea;
        }
        
        .product-info {
            flex: 1;
        }
        
        .product-name {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 0.25rem;
        }
        
        .product-details {
            font-size: 0.9rem;
            color: #718096;
        }
        
        .product-quantity-control {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .quantity-selector {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background: white;
            border: 2px solid #e0e6ff;
            border-radius: 8px;
            padding: 0.5rem;
        }
        
        .qty-btn {
            width: 32px;
            height: 32px;
            border: none;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
            transition: all 0.2s;
        }
        
        .qty-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        
        .qty-btn:active {
            transform: scale(0.95);
        }
        
        .qty-input {
            width: 50px;
            height: 32px;
            border: none;
            background: transparent;
            text-align: center;
            font-weight: 600;
            font-size: 1rem;
            color: #2c3e50;
        }
        
        .qty-input:focus {
            outline: none;
        }
        
        .product-total-price {
            font-weight: 700;
            font-size: 1.1rem;
            color: #4CAF50;
            min-width: 85px;
            text-align: right;
        }
        
        .modal-footer-partial {
            padding: 1.5rem 2rem;
            border-top: 1px solid #e0e6ff;
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
        }
        
        .modal-footer-partial button {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-cancel {
            background: #e0e6ff;
            color: #4a5568;
        }
        
        .btn-cancel:hover {
            background: #d0deff;
        }
        
        .btn-confirm {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
        }
        
        .btn-confirm:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(79, 172, 254, 0.3);
        }
        
        .modal-total-section {
            background: #f0f9f0;
            border: 2px solid #4CAF50;
            border-radius: 12px;
            padding: 1rem;
            margin-top: 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-total-label {
            font-size: 1.1rem;
            font-weight: 600;
            color: #2c3e50;
        }
        
        .modal-total-amount {
            font-size: 1.5rem;
            font-weight: 700;
            color: #4CAF50;
        }
        
        /* Loading Spinner */
        .loading {
            display: none;
            text-align: center;
            padding: 2rem;
        }
        
        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #ff7e5f;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Devoluciones History */
        .devoluciones-history {
            background: #f8f9ff;
            padding: 2rem;
            border-radius: 20px;
            margin-top: 2rem;
        }
        
        .devoluciones-history h3 {
            color: #2c3e50;
            margin-bottom: 1.5rem;
            font-size: 1.5rem;
        }
        
        .devolucion-item {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            border-left: 4px solid #4facfe;
        }
        
        .devolucion-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        
        .devolucion-type {
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        
        .devolucion-type.total {
            background: #ffebee;
            color: #c62828;
        }
        
        .devolucion-type.parcial {
            background: #e3f2fd;
            color: #1565c0;
        }
        
        .devolucion-products {
            margin-top: 1rem;
        }
        
        .devolucion-product-item {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem 0;
            border-bottom: 1px solid #e0e6ff;
        }
        
        .devolucion-product-item:last-child {
            border-bottom: none;
        }
        
        /* Category Badge */
        .category-badge {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .category-bebida {
            background: #4CAF50;
            color: white;
        }
        
        .category-otros {
            background: #667eea;
            color: white;
        }
        
        /* Debug Info Styles */
        .debug-info {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 10px;
            padding: 1rem;
            margin-top: 1rem;
            display: none;
        }
        
        .debug-header {
            color: #856404;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .debug-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 0.5rem;
            font-size: 0.9rem;
        }
        
        .debug-table th {
            background: #ffd700;
            padding: 0.5rem;
            text-align: left;
        }
        
        .debug-table td {
            padding: 0.5rem;
            border: 1px solid #ffeaa7;
        }
        
        .debug-button {
            background: #ffc107;
            color: #856404;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 5px;
            margin-top: 1rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .debug-button:hover {
            background: #e0a800;
        }
        
        /* Stock Reposition Info */
        .stock-info {
            background: #e8f5e9;
            border: 1px solid #c8e6c9;
            border-radius: 10px;
            padding: 1rem;
            margin-top: 1rem;
        }
        
        .stock-info h4 {
            color: #2e7d32;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        /* Responsive design */
        @media (max-width: 992px) {
            .main-content {
                margin-left: 0;
                padding: 5rem 1rem 1rem;
            }
            
            .menu-toggle {
                display: block;
            }
            
            .sidebar {
                transform: translateX(-100%);
            }
            
            .sidebar.open {
                transform: translateX(0);
            }
            
            .sidebar-overlay.open {
                display: block;
            }
            
            .content {
                padding: 1.5rem;
            }
            
            .header {
                padding: 2rem 1.5rem;
            }
            
            .header h1 {
                font-size: 1.8rem;
            }
            
            .search-box {
                flex-direction: column;
            }
            
            .invoice-header-info {
                flex-direction: column;
                gap: 1rem;
            }
            
            .invoice-meta {
                text-align: left;
            }
        }
        
        @media (max-width: 768px) {
            .action-buttons {
                flex-direction: column;
            }
            
            .items-table {
                display: block;
                overflow-x: auto;
            }
            
            .customer-info {
                grid-template-columns: 1fr;
            }
            
            .product-item-wrapper {
                flex-direction: column;
                align-items: stretch;
                gap: 1rem;
            }
            
            .product-quantity-control {
                justify-content: space-between;
            }
        }
        
        @media (max-width: 480px) {
            .search-section {
                padding: 1.5rem;
            }
            
            .invoice-items, .invoice-summary, .return-actions {
                padding: 1.5rem;
            }
            
            .btn-return {
                padding: 1rem 1.5rem;
                font-size: 0.9rem;
            }
        }
    </style>
</head>
<body>
    <!-- Mobile menu toggle -->
    <button class="menu-toggle" id="menuToggle"><i class="fas fa-bars"></i></button>
    
    <!-- Overlay for mobile sidebar -->
    <div class="sidebar-overlay" id="sidebarOverlay"></div>
    
    <div class="app-container">
        <!-- Sidebar navigation -->
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <i class="fas fa-utensils"></i> 402 FASTFOOD
            </div>
            <nav class="sidebar-nav">
                <a href="{% url 'pedidos' %}" class="nav-item">
                    <span class="nav-icon"><i class="fas fa-shopping-cart"></i></span>
                    <span>Pedidos</span>
                </a>
                <a href="{% url 'facturacion' %}" class="nav-item">
                    <span class="nav-icon"><i class="fas fa-file-invoice"></i></span>
                    <span>Facturación</span>
                </a>
                <a href="{% url 'anulacionydevolucion' %}" class="nav-item active">
                    <span class="nav-icon"><i class="fas fa-undo"></i></span>
                    <span>Devoluciones</span>
                </a>
                <a href="" class="nav-item">
                    <span class="nav-icon"><i class="fas fa-chart-bar"></i></span>
                    <span>Reportes</span>
                </a>
                <div style="margin-top: auto; padding-top: 1rem; border-top: 1px solid rgba(255,255,255,0.1);">
                    <a href="{% url 'logout' %}" class="nav-item">
                        <span class="nav-icon"><i class="fas fa-sign-out-alt"></i></span>
                        <span>Cerrar Sesión</span>
                    </a>
                </div>
            </nav>
        </div>
        
        <div class="main-content">
            <div class="container">
                <div class="header">
                    <h1><i class="fas fa-undo"></i> Sistema de Devoluciones</h1>
                    <p>Busca facturas por número para procesar devoluciones y anulaciones</p>
                </div>
                
                <div class="content">
                    <!-- Mensajes de Django -->
                    <div class="messages-container">
                        {% if messages %}
                            {% for message in messages %}
                                <div class="alert alert-{{ message.tags }}">
                                    {% if message.tags == 'success' %}
                                        <i class="fas fa-check-circle"></i>
                                    {% elif message.tags == 'error' %}
                                        <i class="fas fa-exclamation-circle"></i>
                                    {% elif message.tags == 'warning' %}
                                        <i class="fas fa-exclamation-triangle"></i>
                                    {% else %}
                                        <i class="fas fa-info-circle"></i>
                                    {% endif %}
                                    {{ message }}
                                </div>
                            {% endfor %}
                        {% endif %}
                    </div>
                    
                    <!-- Search Section -->
                    <div class="search-section">
                        <h2 class="search-title">
                            <i class="fas fa-search"></i>
                            Buscar Factura por Número
                        </h2>
                        
                        <form method="GET" action="{% url 'anulacionydevolucion' %}" class="search-box">
                            <input 
                                type="text" 
                                class="invoice-input" 
                                id="invoiceNumber"
                                name="numero_factura"
                                placeholder="Ej: FAC-202401-000001"
                                autocomplete="off"
                                autofocus
                                value="{{ request.GET.numero_factura|default:'' }}"
                            >
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-search"></i>
                                <span>Buscar</span>
                            </button>
                            <a href="{% url 'anulacionydevolucion' %}?ultima=true" class="btn-quick-action" title="Cargar la última factura registrada">
                                <i class="fas fa-history"></i>
                                <span>Última</span>
                            </a>
                            <button type="button" class="btn-quick-action" onclick="clearInvoiceInput()" title="Limpiar el campo de búsqueda">
                                <i class="fas fa-times"></i>
                                <span>Limpiar</span>
                            </button>
                        </form>
                        
                        <p style="color: #718096; margin-bottom: 0; margin-top: 0.75rem; font-size: 0.9rem;">
                            Ingresa el número completo de la factura o usa el botón ⏱️ Última para cargar la última factura
                        </p>
                        
                        <div class="loading" id="loadingSpinner">
                            <div class="spinner"></div>
                            <p>Buscando factura...</p>
                        </div>
                    </div>
                    
                    <!-- Invoice Display (se mostrará cuando haya resultados) -->
                    {% if factura %}
                    <div class="invoice-display" id="invoiceDisplay">
                        <div class="invoice-header">
                            <div class="invoice-header-info">
                                <div>
                                    <h2 class="invoice-title">Factura: {{ factura.numero_factura }}</h2>
                                    <p>Fecha: {{ factura.fecha_factura|date:"d/m/Y H:i" }}</p>
                                    <p>Vendedor: {{ factura.creado_por.get_full_name|default:factura.creado_por.username }}</p>
                                </div>
                                <div class="invoice-meta">
                                    <div><strong>Tipo:</strong> {{ factura.tipo_pedido }}</div>
                                    <div><strong>{% if factura.tipo_pedido == 'Mesa' %}Mesa:{% else %}Referencia:{% endif %}</strong> {{ factura.numero_mesa_codigo|default:"N/A" }}</div>
                                    <div class="invoice-status status-{{ factura.estado }}">
                                        {{ factura.get_estado_display }}
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Información sobre reposición de stock -->
                            <div class="stock-info">
                                <h4><i class="fas fa-info-circle"></i> Información sobre reposición de stock:</h4>
                                <ul style="color: #2e7d32; margin-left: 1.5rem;">
                                    <li>Solo los productos con categoría <strong>"bebida"</strong> reponen stock</li>
                                    <li>Los productos de otras categorías no afectan el inventario</li>
                                    <li>El sistema buscará automáticamente los productos por código o nombre</li>
                                </ul>
                            </div>
                            
                            <div class="invoice-customer">
                                <h4><i class="fas fa-user"></i> Información del Cliente</h4>
                                <div class="customer-info">
                                    <div>
                                        <strong>Nombre:</strong> {{ factura.nombre_cliente|default:"No especificado" }}
                                    </div>
                                    <div>
                                        <strong>Teléfono:</strong> {{ factura.telefono_cliente|default:"No especificado" }}
                                    </div>
                                    <div>
                                        <strong>Dirección:</strong> {{ factura.direccion_entrega|default:"No especificada" }}
                                    </div>
                                    <div>
                                        <strong>Método de Pago:</strong> {{ factura.get_metodo_pago_display }}
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="invoice-items">
                            <h3><i class="fas fa-list"></i> Detalles de la Factura</h3>
                            
                            {% if items and items|length > 0 %}
                            <table class="items-table">
                                <thead>
                                    <tr>
                                        <th>#</th>
                                        <th>Producto</th>
                                        <th>Código</th>
                                        <th>Categoría</th>
                                        <th>Cantidad</th>
                                        <th>Precio Unitario</th>
                                        <th>Subtotal</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for item in items %}
                                    <tr>
                                        <td>{{ forloop.counter }}</td>
                                        <td>{{ item.nombre }}</td>
                                        <td>{{ item.codigo|default:"No disponible" }}</td>
                                        <td>
                                            {% if item.categoria == 'bebida' %}
                                                <span class="category-badge category-bebida">{{ item.categoria|upper }}</span>
                                            {% elif item.categoria %}
                                                <span class="category-badge category-otros">{{ item.categoria|upper }}</span>
                                            {% else %}
                                                <span style="color: #718096;">N/A</span>
                                            {% endif %}
                                        </td>
                                        <td>{{ item.cantidad }}</td>
                                        <td>${{ item.precio|floatformat:2 }}</td>
                                        <td>${{ item.subtotal|floatformat:2 }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                            
                            <!-- Botón para mostrar información de depuración -->
                            <button class="debug-button" onclick="toggleDebugInfo()">
                                <i class="fas fa-bug"></i> Mostrar información de depuración
                            </button>
                            
                            <!-- Información de depuración (oculta por defecto) -->
                            <div class="debug-info" id="debugInfo">
                                <div class="debug-header">
                                    <h4><i class="fas fa-bug"></i> Información de depuración</h4>
                                    <button onclick="toggleDebugInfo()" style="background: none; border: none; color: #856404; cursor: pointer;">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                                <div><strong>Total de items:</strong> {{ items|length }}</div>
                                <div><strong>Items JSON:</strong> {{ items_json|truncatechars:200 }}</div>
                                
                                <h5 style="margin-top: 1rem;">Detalle de Items desde la base de datos:</h5>
                                <table class="debug-table">
                                    <thead>
                                        <tr>
                                            <th>#</th>
                                            <th>Nombre</th>
                                            <th>Código</th>
                                            <th>Cantidad</th>
                                            <th>Precio</th>
                                            <th>Categoría</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for item in items %}
                                        <tr>
                                            <td>{{ forloop.counter }}</td>
                                            <td>{{ item.nombre }}</td>
                                            <td>{{ item.codigo|default:"No disponible" }}</td>
                                            <td>{{ item.cantidad }}</td>
                                            <td>${{ item.precio|floatformat:2 }}</td>
                                            <td>{{ item.categoria }}</td>
                                        </tr>
                                        {% empty %}
                                        <tr>
                                            <td colspan="6" style="text-align: center;">No hay items</td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                            
                            {% else %}
                            <div style="text-align: center; padding: 2rem; background: #f8f9fa; border-radius: 10px; margin: 1rem 0;">
                                <i class="fas fa-exclamation-triangle" style="font-size: 3rem; color: #ffc107; margin-bottom: 1rem;"></i>
                                <h4 style="color: #856404;">No se encontraron productos en esta factura</h4>
                                <p style="color: #718096;">La factura no contiene items o no se pudieron cargar.</p>
                                
                                <!-- Botón para mostrar depuración incluso si no hay items -->
                                <button class="debug-button" onclick="toggleDebugInfo()" style="margin-top: 1rem;">
                                    <i class="fas fa-bug"></i> Mostrar información de depuración
                                </button>
                                
                                <div class="debug-info" id="debugInfo">
                                    <div class="debug-header">
                                        <h4><i class="fas fa-bug"></i> Información de depuración</h4>
                                        <button onclick="toggleDebugInfo()" style="background: none; border: none; color: #856404; cursor: pointer;">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    </div>
                                    <div><strong>Items JSON:</strong> {{ items_json }}</div>
                                    <div><strong>Campo items de factura:</strong> {{ factura.items|truncatechars:200 }}</div>
                                </div>
                            </div>
                            {% endif %}
                            
                            <div class="invoice-summary">
                                <div class="summary-row">
                                    <span>Subtotal:</span>
                                    <span>${{ factura.subtotal|floatformat:2 }}</span>
                                </div>
                                <div class="summary-row">
                                    <span>IVA (12%):</span>
                                    <span>${{ factura.iva|floatformat:2 }}</span>
                                </div>
                                {% if factura.envio and factura.envio > 0 %}
                                <div class="summary-row">
                                    <span>Envío:</span>
                                    <span>${{ factura.envio|floatformat:2 }}</span>
                                </div>
                                {% endif %}
                                {% if factura.descuento and factura.descuento > 0 %}
                                <div class="summary-row">
                                    <span>Descuento:</span>
                                    <span>-${{ factura.descuento|floatformat:2 }}</span>
                                </div>
                                {% endif %}
                                <div class="summary-row summary-total">
                                    <span>Total:</span>
                                    <span class="total-amount">${{ factura.total|floatformat:2 }}</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Sección de Acciones de Devolución -->
                        {% if factura.estado == 'pagada' %}
                        <div class="return-actions">
                            <h3><i class="fas fa-undo"></i> Acciones de Devolución</h3>
                            <div class="action-buttons">
                                <form method="POST" action="{% url 'procesar_devolucion_total' %}" style="display: inline;">
                                    {% csrf_token %}
                                    <input type="hidden" name="numero_factura" value="{{ factura.numero_factura }}">
                                    <button type="submit" class="btn-return full" onclick="return confirmDevolucionTotal()">
                                        <i class="fas fa-undo"></i>
                                        <span>Devolver Todo</span>
                                    </button>
                                </form>
                                
                                <button type="button" class="btn-return partial" onclick="abrirModalDevolucionParcial()">
                                    <i class="fas fa-list-check"></i>
                                    <span>Devolver Items</span>
                                </button>
                                
                                <button type="button" class="btn-return exchange" onclick="mostrarMensajeCambio()">
                                    <i class="fas fa-exchange-alt"></i>
                                    <span>Cambiar Producto</span>
                                </button>
                            </div>
                            <p style="color: #718096; margin-top: 1rem; font-size: 0.9rem;">
                                <i class="fas fa-info-circle"></i> Los productos de categoría "bebida" se reponen automáticamente en el inventario.
                            </p>
                        </div>
                        
                        <!-- Sección de Anulación -->
                        <div class="return-actions">
                            <h3><i class="fas fa-ban"></i> Acciones de Anulación</h3>
                            <div class="action-buttons">
                                <button type="button" class="btn-return full" style="background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);" 
                                        onclick="abrirModalAnulacion()">
                                    <i class="fas fa-ban"></i>
                                    <span>Anular Factura</span>
                                </button>
                            </div>
                            <p style="color: #718096; margin-top: 1rem; font-size: 0.9rem;">
                                <i class="fas fa-info-circle"></i> La anulación cambiará el estado de la factura y disminuirá el stock de bebidas.
                            </p>
                        </div>
                        
                        {% elif factura.estado == 'parcialmente_devuelta' %}
                        <div class="return-actions">
                            <h3><i class="fas fa-info-circle"></i> Factura Parcialmente Devuelta</h3>
                            <p style="text-align: center; color: #667eea; margin-bottom: 1rem;">
                                <i class="fas fa-exclamation-triangle"></i> Esta factura ya tiene devoluciones procesadas.
                            </p>
                            <div class="action-buttons">
                                <button type="button" class="btn-return partial" onclick="abrirModalDevolucionParcial()">
                                    <i class="fas fa-list-check"></i>
                                    <span>Devolver Más Items</span>
                                </button>
                            </div>
                        </div>
                        {% elif factura.estado == 'totalmente_devuelta' %}
                        <div class="return-actions">
                            <h3><i class="fas fa-check-circle"></i> Factura Totalmente Devuelta</h3>
                            <p style="text-align: center; color: #4CAF50; margin-bottom: 1rem;">
                                <i class="fas fa-check"></i> Todos los productos de esta factura han sido devueltos.
                            </p>
                        </div>
                        {% elif factura.estado == 'anulada' %}
                        <div class="return-actions">
                            <h3><i class="fas fa-ban"></i> Factura Anulada</h3>
                            <p style="text-align: center; color: #ff416c; margin-bottom: 1rem;">
                                <i class="fas fa-exclamation-circle"></i> Esta factura ha sido anulada y no permite devoluciones.
                            </p>
                            {% if factura.motivo_anulacion %}
                            <div style="background: #ffebee; padding: 1rem; border-radius: 10px; margin-top: 1rem;">
                                <strong>Motivo de anulación:</strong> {{ factura.motivo_anulacion }}
                            </div>
                            {% endif %}
                        </div>
                        {% else %}
                        <div class="return-actions">
                            <h3><i class="fas fa-clock"></i> Factura Pendiente</h3>
                            <p style="text-align: center; color: #ffd700; margin-bottom: 1rem;">
                                <i class="fas fa-exclamation-triangle"></i> Solo se pueden devolver facturas que estén en estado "Pagada".
                            </p>
                        </div>
                        {% endif %}
                        
                        <!-- Historial de Devoluciones -->
                        <div class="devoluciones-history">
                            <h3><i class="fas fa-history"></i> Historial de Devoluciones</h3>
                            
                            <div id="devolucionesContainer">
                                <!-- Los productos devueltos se cargarán aquí dinámicamente -->
                                <p id="sinDevoluciones" style="text-align: center; color: #718096;">
                                    <i class="fas fa-info-circle"></i> 
                                    No hay devoluciones registradas para esta factura.
                                </p>
                            </div>
                        </div>
                    </div>
                    {% else %}
                    <!-- Initial empty state -->
                    <div class="empty-state" id="emptyState">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
                        </svg>
                        <h3>No se ha buscado ninguna factura</h3>
                        <p>Ingresa un número de factura en el campo de arriba para ver su contenido</p>
                        <div style="margin-top: 2rem; font-size: 0.9rem; color: #718096;">
                            <p><strong>Tip:</strong> También puedes hacer clic en "Última" para cargar la última factura registrada.</p>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <!-- Modal de Devolución Parcial -->
        <div class="modal-overlay" id="partialReturnModal">
            <div class="modal-content-partial">
                <div class="modal-header-partial">
                    <h2><i class="fas fa-undo"></i> Devolución Parcial</h2>
                    <button class="modal-close" onclick="cerrarModalDevolucionParcial()">&times;</button>
                </div>
                <form method="POST" action="{% url 'procesar_devolucion_parcial' %}" id="formDevolucionParcial">
                    {% csrf_token %}
                    <div class="modal-body-partial">
                        <p style="margin-bottom: 1.5rem; color: #4a5568;">
                            Selecciona los productos que deseas devolver:
                        </p>
                        <div class="product-list" id="productListModal">
                            <!-- Los productos se cargarán dinámicamente aquí -->
                        </div>
                        <div class="modal-total-section">
                            <span class="modal-total-label">Total a Devolver:</span>
                            <span class="modal-total-amount" id="partialReturnTotal">$0.00</span>
                        </div>
                        <input type="hidden" name="numero_factura" id="modalFacturaNumero" value="{{ factura.numero_factura|default:'' }}">
                        <input type="hidden" name="productos_devueltos" id="productosDevueltosInput" value="[]">
                    </div>
                    <div class="modal-footer-partial">
                        <button type="button" class="btn-cancel" onclick="cerrarModalDevolucionParcial()">Cancelar</button>
                        <button type="submit" class="btn-confirm" id="confirmarDevolucionBtn">
                            <i class="fas fa-check"></i> Procesar Devolución
                        </button>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- Modal de Anulación -->
        <div class="modal-overlay" id="anulacionModal">
            <div class="modal-content-partial">
                <div class="modal-header-partial" style="background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);">
                    <h2><i class="fas fa-ban"></i> Anular Factura</h2>
                    <button class="modal-close" onclick="cerrarModalAnulacion()">&times;</button>
                </div>
                <form method="POST" action="{% url 'procesar_anulacion_factura' %}" id="formAnulacion">
                    {% csrf_token %}
                    <div class="modal-body-partial">
                        <p style="color: #dc3545; font-weight: bold; margin-bottom: 1.5rem;">
                            <i class="fas fa-exclamation-triangle"></i> 
                            ADVERTENCIA: Esta acción anulará la factura y disminuirá el stock de productos bebida.
                        </p>
                        
                        <div style="background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 10px; padding: 1rem; margin-bottom: 1.5rem;">
                            <h4 style="color: #856404; margin-bottom: 0.5rem;">
                                <i class="fas fa-info-circle"></i> Información de la factura:
                            </h4>
                            <div><strong>Número:</strong> {{ factura.numero_factura }}</div>
                            <div><strong>Cliente:</strong> {{ factura.nombre_cliente|default:"No especificado" }}</div>
                            <div><strong>Total:</strong> ${{ factura.total|floatformat:2 }}</div>
                        </div>
                        
                        <div style="margin-bottom: 1.5rem;">
                            <label for="motivoAnulacion" style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #2c3e50;">
                                <i class="fas fa-comment-alt"></i> Motivo de anulación:
                            </label>
                            <textarea id="motivoAnulacion" name="motivo" rows="4" 
                                      style="width: 100%; padding: 0.75rem; border: 2px solid #e0e6ff; border-radius: 10px; font-family: inherit;"
                                      placeholder="Ej: Error en el pedido, cliente canceló, etc." required></textarea>
                        </div>
                        
                        <div style="background: #f8d7da; border: 1px solid #f5c6cb; border-radius: 10px; padding: 1rem; color: #721c24;">
                            <h4 style="margin-bottom: 0.5rem;">
                                <i class="fas fa-exclamation-circle"></i> Efectos de la anulación:
                            </h4>
                            <ul style="margin-left: 1.5rem;">
                                <li>La factura cambiará a estado "Anulada"</li>
                                <li>Los productos de categoría "bebida" disminuirán su stock</li>
                                <li>No se podrán realizar devoluciones sobre esta factura</li>
                                <li>Se registrará el motivo de anulación</li>
                            </ul>
                        </div>
                        
                        <input type="hidden" name="numero_factura" value="{{ factura.numero_factura|default:'' }}">
                    </div>
                    <div class="modal-footer-partial">
                        <button type="button" class="btn-cancel" onclick="cerrarModalAnulacion()">Cancelar</button>
                        <button type="submit" class="btn-confirm" style="background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);">
                            <i class="fas fa-ban"></i> Confirmar Anulación
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

   <script>
    // Datos de la factura actual (si existe)
    {% if factura %}
    const facturaActual = {
        numero: "{{ factura.numero_factura }}",
        estado: "{{ factura.estado }}",
        items: {{ items_json|safe }},
        productosDisponibles: {{ productos_disponibles_json|safe }},
        productosDevueltos: {{ productos_devueltos_json|safe }}
    };
    
    console.log('✅ Factura actual cargada:', facturaActual.numero);
    console.log('📦 Items en factura:', facturaActual.items.length);
    console.log('✅ Productos disponibles para devolver:', facturaActual.productosDisponibles.length);
    console.log('🔄 Productos ya devueltos:', facturaActual.productosDevueltos.length);
    
    if (facturaActual.items && facturaActual.items.length > 0) {
        console.log('📋 Detalle de productos:');
        facturaActual.items.forEach((item, index) => {
            console.log(`  ${index + 1}. ${item.nombre || 'Sin nombre'}`);
            console.log(`     Código: "${item.codigo || 'No disponible'}"`);
            console.log(`     Categoría: "${item.categoria || 'No disponible'}"`);
            console.log(`     Cantidad: ${item.cantidad || 0}`);
            console.log(`     Precio: $${item.precio || 0}`);
        });
    } else {
        console.warn('⚠️  No hay items en la factura');
    }
    
    {% else %}
    const facturaActual = null;
    console.log('ℹ️  No hay factura cargada');
    {% endif %}

    // Inicializar la aplicación
    document.addEventListener('DOMContentLoaded', function() {
        console.log('🚀 DOM cargado completamente');
        setupEventListeners();
        
        // Permitir búsqueda con Enter
        const invoiceInput = document.getElementById('invoiceNumber');
        if (invoiceInput) {
            invoiceInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    this.form.submit();
                }
            });
        }
        
        // Si hay factura cargada, preparar el modal
        if (facturaActual) {
            console.log('📄 Preparando modales para factura:', facturaActual.numero);
            prepararModalDevolucionParcial();
            prepararModalAnulacion();
            cargarHistorialDevoluciones();
            
            // Mostrar información de depuración si hay problemas
            if (!facturaActual.items || facturaActual.items.length === 0) {
                console.warn('⚠️  La factura no tiene items. Mostrando información de depuración.');
                setTimeout(() => {
                    const debugInfo = document.getElementById('debugInfo');
                    if (debugInfo) {
                        debugInfo.style.display = 'block';
                    }
                }, 1000);
            }
        }
    });
    
    // Configurar event listeners
    function setupEventListeners() {
        // Menú móvil
        const menuToggle = document.getElementById('menuToggle');
        const sidebarOverlay = document.getElementById('sidebarOverlay');
        
        if (menuToggle) {
            menuToggle.addEventListener('click', toggleSidebar);
        }
        if (sidebarOverlay) {
            sidebarOverlay.addEventListener('click', toggleSidebar);
        }
        
        // Cerrar modales con ESC
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                cerrarModalDevolucionParcial();
                cerrarModalAnulacion();
            }
        });
    }
    
    // Alternar barra lateral en móvil
    function toggleSidebar() {
        const sidebar = document.getElementById('sidebar');
        const overlay = document.getElementById('sidebarOverlay');
        sidebar.classList.toggle('open');
        overlay.classList.toggle('open');
    }
    
    // Limpiar campo de búsqueda
    function clearInvoiceInput() {
        const invoiceInput = document.getElementById('invoiceNumber');
        if (invoiceInput) {
            invoiceInput.value = '';
            invoiceInput.focus();
        }
        
        // Redirigir a la página sin parámetros
        window.location.href = "{% url 'anulacionydevolucion' %}";
    }
    
    // Alternar información de depuración
    function toggleDebugInfo() {
        const debugInfo = document.getElementById('debugInfo');
        if (debugInfo) {
            debugInfo.style.display = debugInfo.style.display === 'none' ? 'block' : 'none';
        }
    }
    
    // Confirmación personalizada para devolución total
    function confirmDevolucionTotal() {
        if (!facturaActual) return false;
        
        const bebidas = facturaActual.items.filter(item => 
            item.categoria && item.categoria.toLowerCase() === 'bebida'
        );
        
        let mensaje = '¿Estás seguro de devolver TODOS los productos de esta factura?\n\n';
        
        if (bebidas.length > 0) {
            mensaje += `Se repondrá el stock de ${bebidas.length} producto(s) bebida:\n`;
            bebidas.forEach((bebida, index) => {
                mensaje += `  • ${bebida.nombre} (${bebida.cantidad} unidad(es))\n`;
            });
        } else {
            mensaje += 'No hay productos bebida para reponer stock.\n';
        }
        
        mensaje += `\nMonto total a devolver: $${facturaActual.items.reduce((sum, item) => 
            sum + (item.cantidad * item.precio), 0).toFixed(2)}`;
        
        return confirm(mensaje);
    }
    
    // Cargar historial de devoluciones
    function cargarHistorialDevoluciones() {
        if (!facturaActual || !facturaActual.productosDevueltos) {
            console.warn('No hay productos devueltos para mostrar');
            return;
        }
        
        const container = document.getElementById('devolucionesContainer');
        const sinDevoluciones = document.getElementById('sinDevoluciones');
        
        if (!container) return;
        
        // Verificar si hay productos devueltos
        if (facturaActual.productosDevueltos && facturaActual.productosDevueltos.length > 0) {
            // Ocultar mensaje "sin devoluciones"
            if (sinDevoluciones) sinDevoluciones.style.display = 'none';
            
            // Calcular monto total devuelto
            let montoTotal = 0;
            let bebidasDevueltas = 0;
            
            facturaActual.productosDevueltos.forEach(producto => {
                montoTotal += parseFloat(producto.subtotal) || 0;
                if (producto.categoria && producto.categoria.toLowerCase() === 'bebida') {
                    bebidasDevueltas += parseInt(producto.cantidad) || 0;
                }
            });
            
            // Crear encabezado con monto total
            const headerHTML = `
                <div style="background: #e8f4f8; border-radius: 10px; padding: 1rem; margin-bottom: 1.5rem;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <strong style="color: #2c3e50;">Total Devuelto:</strong>
                            <div style="font-size: 1.8rem; font-weight: bold; color: #4CAF50;">
                                $${montoTotal.toFixed(2)}
                            </div>
                        </div>
                        <div style="color: #718096; font-size: 0.9rem; text-align: right;">
                            <div><i class="fas fa-boxes"></i> ${facturaActual.productosDevueltos.length} producto(s) devuelto(s)</div>
                            ${bebidasDevueltas > 0 ? `<div><i class="fas fa-wine-bottle"></i> ${bebidasDevueltas} bebida(s) repuesta(s) en stock</div>` : ''}
                        </div>
                    </div>
                </div>
            `;
            
            // Crear lista de productos
            let productosHTML = '';
            facturaActual.productosDevueltos.forEach((producto, index) => {
                const esBebida = producto.categoria && producto.categoria.toLowerCase() === 'bebida';
                productosHTML += `
                    <div class="devolucion-product-item" style="animation-delay: ${index * 0.1}s;">
                        <div style="flex: 1;">
                            <div style="font-weight: 600; color: #2c3e50;">${producto.nombre}</div>
                            <div style="font-size: 0.85rem; color: #718096; margin-top: 0.25rem;">
                                <span>Cantidad: ${producto.cantidad}</span>
                                ${producto.codigo ? `<span style="margin-left: 1rem;">Código: ${producto.codigo}</span>` : ''}
                                ${esBebida ? '<span style="margin-left: 1rem; color: #4CAF50;"><i class="fas fa-wine-bottle"></i> Bebida (stock repuesto)</span>' : ''}
                            </div>
                        </div>
                        <div style="font-weight: 700; color: #4CAF50;">
                            $${parseFloat(producto.subtotal || 0).toFixed(2)}
                        </div>
                    </div>
                `;
            });
            
            // Actualizar contenedor
            container.innerHTML = headerHTML + productosHTML;
        } else {
            // Mostrar mensaje "sin devoluciones"
            if (sinDevoluciones) sinDevoluciones.style.display = 'block';
        }
    }
    
    // Preparar modal de devolución parcial
    function prepararModalDevolucionParcial() {
        if (!facturaActual) {
            console.warn('No hay factura actual para preparar el modal de devolución parcial');
            return;
        }
        
        // Cargar productos en el modal
        cargarProductosEnModal();
        
        // Configurar el formulario
        const form = document.getElementById('formDevolucionParcial');
        if (form) {
            form.onsubmit = function(e) {
                const productosSeleccionados = obtenerProductosSeleccionados();
                console.log('Productos seleccionados para devolución:', productosSeleccionados);
                
                if (productosSeleccionados.length === 0) {
                    e.preventDefault();
                    mostrarAlerta('Debes seleccionar al menos un producto para devolver', 'warning');
                    return false;
                }
                
                const total = calcularTotalDevolucion();
                const bebidas = productosSeleccionados.filter(p => 
                    p.categoria && p.categoria.toLowerCase() === 'bebida'
                );
                
                let mensaje = `¿Estás seguro de procesar la devolución de ${productosSeleccionados.length} producto(s) por un total de $${total.toFixed(2)}?\n\n`;
                
                if (bebidas.length > 0) {
                    mensaje += `Se repondrá el stock de ${bebidas.length} producto(s) bebida:\n`;
                    bebidas.forEach((bebida, index) => {
                        mensaje += `  • ${bebida.nombre} (${bebida.cantidad} unidad(es))\n`;
                    });
                }
                
                return confirm(mensaje);
            };
        }
    }
    
    // Preparar modal de anulación
    function prepararModalAnulacion() {
        const formAnulacion = document.getElementById('formAnulacion');
        if (formAnulacion) {
            formAnulacion.onsubmit = function(e) {
                const motivo = document.getElementById('motivoAnulacion').value.trim();
                if (!motivo) {
                    e.preventDefault();
                    mostrarAlerta('Debes ingresar un motivo para la anulación', 'warning');
                    return false;
                }
                
                // Calcular cuántas bebidas se van a disminuir
                const bebidas = facturaActual.items.filter(item => 
                    item.categoria && item.categoria.toLowerCase() === 'bebida'
                );
                
                let mensaje = '¿Estás seguro de anular esta factura?\n\n';
                mensaje += 'EFECTOS:\n';
                mensaje += '• La factura cambiará a estado "Anulada"\n';
                
                if (bebidas.length > 0) {
                    mensaje += `• Se disminuirá el stock de ${bebidas.length} producto(s) bebida:\n`;
                    bebidas.forEach((bebida, index) => {
                        mensaje += `    ${bebida.nombre} (${bebida.cantidad} unidad(es))\n`;
                    });
                } else {
                    mensaje += '• No hay productos bebida para ajustar stock\n';
                }
                
                mensaje += '• No se podrán realizar devoluciones\n';
                mensaje += '• Esta acción NO se puede deshacer\n\n';
                mensaje += 'Motivo: ' + motivo;
                
                return confirm(mensaje);
            };
        }
    }
    
    // Abrir modal de devolución parcial
    function abrirModalDevolucionParcial() {
        console.log('abrirModalDevolucionParcial llamado');
        
        if (!facturaActual) {
            console.error('No hay factura cargada');
            mostrarAlerta('No hay factura cargada', 'error');
            return;
        }
        
        if (facturaActual.estado !== 'pagada' && facturaActual.estado !== 'parcialmente_devuelta') {
            console.warn('Estado de factura no válido para devolución:', facturaActual.estado);
            mostrarAlerta('Solo se pueden devolver facturas pagadas o parcialmente devueltas', 'warning');
            return;
        }
        
        // Asegurarse de que los productos estén cargados
        cargarProductosEnModal();
        
        // Mostrar modal
        const modal = document.getElementById('partialReturnModal');
        if (modal) {
            modal.classList.add('active');
            document.body.style.overflow = 'hidden';
            console.log('Modal de devolución parcial abierto');
        } else {
            console.error('No se encontró el modal con id partialReturnModal');
        }
    }
    
    // Cerrar modal de devolución parcial
    function cerrarModalDevolucionParcial() {
        const modal = document.getElementById('partialReturnModal');
        if (modal) {
            modal.classList.remove('active');
        }
        document.body.style.overflow = '';
        
        // Resetear selecciones
        resetearSeleccionesModal();
    }
    
    // Abrir modal de anulación
    function abrirModalAnulacion() {
        if (!facturaActual) {
            mostrarAlerta('No hay factura cargada', 'error');
            return;
        }
        
        if (facturaActual.estado !== 'pagada' && facturaActual.estado !== 'pendiente') {
            mostrarAlerta('Solo se pueden anular facturas pagadas o pendientes', 'warning');
            return;
        }
        
        const modal = document.getElementById('anulacionModal');
        if (modal) {
            modal.classList.add('active');
            document.body.style.overflow = 'hidden';
        }
    }
    
    // Cerrar modal de anulación
    function cerrarModalAnulacion() {
        const modal = document.getElementById('anulacionModal');
        if (modal) {
            modal.classList.remove('active');
        }
        document.body.style.overflow = '';
        
        // Limpiar el formulario
        const form = document.getElementById('formAnulacion');
        if (form) form.reset();
    }
    
    // Calcular cantidad ya devuelta de un producto
    function calcularCantidadYaDevuelta(productoNombre) {
        if (!facturaActual || !facturaActual.productosDevueltos) return 0;
        
        let totalDevuelto = 0;
        const nombreBuscar = productoNombre.toLowerCase().trim();
        
        facturaActual.productosDevueltos.forEach(producto => {
            const nombreProducto = (producto.nombre || '').toLowerCase().trim();
            if (nombreProducto === nombreBuscar) {
                totalDevuelto += parseFloat(producto.cantidad) || 0;
            }
        });
        
        console.log(`📊 Cantidad ya devuelta de "${productoNombre}": ${totalDevuelto}`);
        return totalDevuelto;
    }
    
    // Cargar productos en el modal
    function cargarProductosEnModal() {
        if (!facturaActual || !facturaActual.productosDisponibles) {
            console.error('No hay productos disponibles para cargar en el modal');
            return;
        }
        
        const productList = document.getElementById('productListModal');
        if (!productList) {
            console.error('No se encontró el contenedor de productos en el modal');
            return;
        }
        
        productList.innerHTML = '';
        
        let tieneProductosDisponibles = false;
        let productosBebida = 0;
        
        console.log('📦 Cargando productos disponibles en modal:', facturaActual.productosDisponibles.length);
        
        facturaActual.productosDisponibles.forEach((item, index) => {
            console.log('Cargando producto en modal:', item);
            const productoNombre = item.nombre || 'Producto sin nombre';
            const cantidadDisponible = item.cantidad_disponible || 0;
            const cantidadYaDevuelta = item.cantidad_ya_devuelta || 0;
            const cantidadOriginal = item.cantidad || 0;
            const codigoProducto = item.codigo || '';
            const categoria = item.categoria || '';
            
            // Solo mostrar productos que todavía se pueden devolver
            if (cantidadDisponible <= 0) {
                console.log(`Producto ${productoNombre} no disponible para devolver (ya devuelto completamente)`);
                return;
            }
            
            tieneProductosDisponibles = true;
            const esBebida = categoria.toLowerCase() === 'bebida';
            if (esBebida) productosBebida++;
            
            const productItem = document.createElement('div');
            productItem.className = 'product-item-wrapper';
            productItem.innerHTML = `
                <label class="product-item">
                    <input type="checkbox" class="product-checkbox" 
                           data-index="${index}"
                           data-nombre="${productoNombre}" 
                           data-codigo="${codigoProducto}"
                           data-price="${item.precio || 0}" 
                           data-max-qty="${cantidadDisponible}"
                           data-categoria="${categoria}"
                           onchange="actualizarTotalDevolucion()">
                    <div class="product-info">
                        <div class="product-name">${productoNombre}</div>
                        <div class="product-details">
                            <div>Precio unitario: $${(item.precio || 0).toFixed(2)}</div>
                            <div>Disponible para devolver: ${cantidadDisponible} de ${cantidadOriginal}</div>
                            ${codigoProducto ? `<div>Código: <strong>${codigoProducto}</strong></div>` : '<div>Código: <em>No disponible</em></div>'}
                            ${cantidadYaDevuelta > 0 ? `<div style="color: #667eea;">Ya devuelto: ${cantidadYaDevuelta}</div>` : ''}
                            ${esBebida ? '<div style="color: #4CAF50;"><i class="fas fa-wine-bottle"></i> Bebida (stock se repone)</div>' : ''}
                        </div>
                    </div>
                </label>
                <div class="product-quantity-control">
                    <div class="quantity-selector">
                        <button type="button" class="qty-btn qty-minus" onclick="disminuirCantidad(${index})" title="Disminuir cantidad">
                            <i class="fas fa-minus"></i>
                        </button>
                        <input type="number" class="qty-input product-qty-${index}" 
                               value="1" min="1" max="${cantidadDisponible}" 
                               onchange="actualizarCantidadDesdeInput(${index})"
                               oninput="validarCantidadInput(${index}, ${cantidadDisponible})">
                        <button type="button" class="qty-btn qty-plus" onclick="aumentarCantidad(${index}, ${cantidadDisponible})" title="Aumentar cantidad">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                    <div class="product-total-price" id="price-${index}">$${(item.precio || 0).toFixed(2)}</div>
                </div>
            `;
            productList.appendChild(productItem);
        });
        
        // Si no hay productos disponibles para devolver
        if (!tieneProductosDisponibles) {
            productList.innerHTML = `
                <div style="text-align: center; padding: 2rem; color: #718096;">
                    <i class="fas fa-check-circle" style="font-size: 3rem; margin-bottom: 1rem; color: #4CAF50;"></i>
                    <p><strong>Todos los productos han sido devueltos</strong></p>
                    <p>No hay productos disponibles para devolver en esta factura.</p>
                </div>
            `;
            const confirmBtn = document.getElementById('confirmarDevolucionBtn');
            if (confirmBtn) confirmBtn.disabled = true;
        } else {
            console.log(`✅ ${productosBebida} producto(s) bebida disponible(s) para reposición de stock`);
        }
        
        actualizarTotalDevolucion();
    }
    
    // Aumentar cantidad en el modal
    function aumentarCantidad(index, maxCantidad) {
        const input = document.querySelector(`.product-qty-${index}`);
        if (!input) return;
        
        const currentValue = parseInt(input.value) || 1;
        const newValue = currentValue + 1;
        
        if (newValue <= maxCantidad) {
            input.value = newValue;
            actualizarCantidad(index, newValue);
        }
    }
    
    // Disminuir cantidad en el modal
    function disminuirCantidad(index) {
        const input = document.querySelector(`.product-qty-${index}`);
        if (!input) return;
        
        const currentValue = parseInt(input.value) || 1;
        if (currentValue > 1) {
            input.value = currentValue - 1;
            actualizarCantidad(index, currentValue - 1);
        }
    }
    
    // Actualizar cantidad desde input
    function actualizarCantidadDesdeInput(index) {
        const input = document.querySelector(`.product-qty-${index}`);
        if (!input) return;
        
        const cantidad = parseInt(input.value) || 1;
        actualizarCantidad(index, cantidad);
    }
    
    // Validar cantidad en input
    function validarCantidadInput(index, maxCantidad) {
        const input = document.querySelector(`.product-qty-${index}`);
        if (!input) return;
        
        let value = parseInt(input.value) || 1;
        
        if (isNaN(value) || value < 1) {
            value = 1;
        } else if (value > maxCantidad) {
            value = maxCantidad;
        }
        
        input.value = value;
        actualizarCantidad(index, value);
    }
    
    // Actualizar cantidad de un producto
    function actualizarCantidad(index, cantidad) {
        const checkbox = document.querySelector(`.product-checkbox[data-index="${index}"]`);
        if (!checkbox) return;
        
        // Validar cantidad máxima
        const maxCantidad = parseInt(checkbox.dataset.maxQty) || 1;
        if (cantidad > maxCantidad) {
            cantidad = maxCantidad;
            const input = document.querySelector(`.product-qty-${index}`);
            if (input) input.value = cantidad;
        }
        
        if (cantidad < 1) {
            cantidad = 1;
            const input = document.querySelector(`.product-qty-${index}`);
            if (input) input.value = cantidad;
        }
        
        if (checkbox.checked) {
            actualizarTotalDevolucion();
        }
    }
    
    // Actualizar total de devolución
    function actualizarTotalDevolucion() {
        const selectedCheckboxes = document.querySelectorAll('.product-checkbox:checked');
        let total = 0;
        let productosSeleccionados = [];
        
        selectedCheckboxes.forEach(checkbox => {
            const index = checkbox.dataset.index;
            const precio = parseFloat(checkbox.dataset.price);
            const cantidad = parseInt(document.querySelector(`.product-qty-${index}`).value) || 1;
            const subtotal = precio * cantidad;
            
            total += subtotal;
            
            // Actualizar precio mostrado
            const priceElement = document.getElementById(`price-${index}`);
            if (priceElement) {
                priceElement.textContent = `$${subtotal.toFixed(2)}`;
            }
            
            productosSeleccionados.push({
                nombre: checkbox.dataset.nombre,
                codigo: checkbox.dataset.codigo || '',
                cantidad: cantidad,
                precio: precio,
                subtotal: subtotal,
                categoria: checkbox.dataset.categoria
            });
        });
        
        // Actualizar total
        const totalElement = document.getElementById('partialReturnTotal');
        if (totalElement) {
            totalElement.textContent = `$${total.toFixed(2)}`;
        }
        
        // Actualizar input hidden con productos seleccionados
        const productosInput = document.getElementById('productosDevueltosInput');
        if (productosInput) {
            productosInput.value = JSON.stringify(productosSeleccionados);
            console.log('Productos a devolver:', productosSeleccionados);
        }
        
        // Habilitar/deshabilitar botón de confirmar
        const confirmBtn = document.getElementById('confirmarDevolucionBtn');
        if (confirmBtn) {
            if (selectedCheckboxes.length > 0) {
                confirmBtn.disabled = false;
            } else {
                confirmBtn.disabled = true;
            }
        }
    }
    
    // Obtener productos seleccionados
    function obtenerProductosSeleccionados() {
        const selectedCheckboxes = document.querySelectorAll('.product-checkbox:checked');
        let productos = [];
        
        selectedCheckboxes.forEach(checkbox => {
            const index = checkbox.dataset.index;
            const cantidad = parseInt(document.querySelector(`.product-qty-${index}`).value) || 1;
            
            productos.push({
                nombre: checkbox.dataset.nombre,
                codigo: checkbox.dataset.codigo || '',
                cantidad: cantidad,
                precio: parseFloat(checkbox.dataset.price),
                categoria: checkbox.dataset.categoria
            });
        });
        
        return productos;
    }
    
    // Calcular total de devolución
    function calcularTotalDevolucion() {
        const selectedCheckboxes = document.querySelectorAll('.product-checkbox:checked');
        let total = 0;
        
        selectedCheckboxes.forEach(checkbox => {
            const index = checkbox.dataset.index;
            const precio = parseFloat(checkbox.dataset.price);
            const cantidad = parseInt(document.querySelector(`.product-qty-${index}`).value) || 1;
            total += precio * cantidad;
        });
        
        return total;
    }
    
    // Resetear selecciones del modal
    function resetearSeleccionesModal() {
        document.querySelectorAll('.product-checkbox').forEach(cb => cb.checked = false);
        document.querySelectorAll('.qty-input').forEach(input => {
            if (input) input.value = '1';
        });
        
        // Resetear todos los precios individuales
        document.querySelectorAll('.product-total-price').forEach((priceEl, index) => {
            const checkbox = document.querySelector(`.product-checkbox[data-index="${index}"]`);
            if (checkbox) {
                const precio = parseFloat(checkbox.dataset.price) || 0;
                priceEl.textContent = `$${precio.toFixed(2)}`;
            }
        });
        
        const totalElement = document.getElementById('partialReturnTotal');
        if (totalElement) {
            totalElement.textContent = '$0.00';
        }
        
        const confirmBtn = document.getElementById('confirmarDevolucionBtn');
        if (confirmBtn) {
            confirmBtn.disabled = true;
        }
    }
    
    // Mostrar mensaje para cambio de producto
    function mostrarMensajeCambio() {
        mostrarAlerta('La funcionalidad de cambio de producto está en desarrollo. Por ahora, usa la opción "Devolver Items" y crea una nueva factura para el cambio.', 'info');
    }
    
    // Mostrar alerta
    function mostrarAlerta(mensaje, tipo = 'info') {
        // Crear elemento de alerta
        const alerta = document.createElement('div');
        alerta.className = `alert alert-${tipo}`;
        
        // Icono según tipo
        let icono = 'info-circle';
        if (tipo === 'success') icono = 'check-circle';
        if (tipo === 'error') icono = 'exclamation-circle';
        if (tipo === 'warning') icono = 'exclamation-triangle';
        
        alerta.innerHTML = `
            <i class="fas fa-${icono}"></i>
            ${mensaje}
        `;
        
        // Agregar al contenedor de mensajes
        const mensajesContainer = document.querySelector('.messages-container');
        if (mensajesContainer) {
            mensajesContainer.appendChild(alerta);
            
            // Remover después de 5 segundos
            setTimeout(() => {
                if (alerta.parentElement) {
                    alerta.style.opacity = '0';
                    alerta.style.transition = 'opacity 0.3s';
                    setTimeout(() => {
                        if (alerta.parentElement) {
                            alerta.remove();
                        }
                    }, 300);
                }
            }, 5000);
        }
    }
    
    // Mostrar loading
    function mostrarLoading() {
        const loadingElement = document.getElementById('loadingSpinner');

if (loadingElement) {
        loadingElement.style.display = 'block';
    }
}

// Ocultar loading
function ocultarLoading() {
    const loadingElement = document.getElementById('loadingSpinner');
    if (loadingElement) {
        loadingElement.style.display = 'none';
    }
}
    </script>
</body>
</html>